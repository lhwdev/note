<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Where I write what I want to write"><meta name=author content=lhwdev><link href=http://lhwdev.github.io/note/other/windows-self-driver-signing/ rel=canonical><link href=../../compose/how-it-works/ rel=prev><link href=../windows-self-driver-signing-en/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.2, mkdocs-material-9.3.1"><title>윈도우에서 직접 드라이버 서명하기 - Note</title><link rel=stylesheet href=../../assets/stylesheets/main.046329b4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.85d0ee34.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Note - 윈도우에서 직접 드라이버 서명하기"><meta property=og:description content="Where I write what I want to write"></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#_1 class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=Note class="md-header__button md-logo" aria-label=Note data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Note </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 윈도우에서 직접 드라이버 서명하기 </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lhwdev/note title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=Note class="md-nav__button md-logo" aria-label=Note data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Note </label> <div class=md-nav__source> <a href=https://github.com/lhwdev/note title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../making/ class=md-nav__link> <span class=md-ellipsis> Making this site </span> </a> </li> <li class=md-nav__item> <a href=../../debug-page/ class=md-nav__link> <span class=md-ellipsis> Debug page </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> 고등학교 개발 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 고등학교 개발 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../high/covid-selftest-macro/ class=md-nav__link> <span class=md-ellipsis> 코로나19 자가진단 매크로를 만들며 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Android </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../android/transparent-status-bar/ class=md-nav__link> <span class=md-ellipsis> Transparent status bar in Android </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Kotlin Compiler Plugin </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Kotlin Compiler Plugin </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kotlin-compiler-plugin/backend-ir/ class=md-nav__link> <span class=md-ellipsis> Writing a Kotlin Backend IR Compiler Plugin </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Jetpack compose </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Jetpack compose </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../compose/how-it-works/ class=md-nav__link> <span class=md-ellipsis> How Compose Works </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8 checked> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Other </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=true> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Other </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 윈도우에서 직접 드라이버 서명하기 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 윈도우에서 직접 드라이버 서명하기 </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 왜? </a> </li> <li class=md-nav__item> <a href=#unsigned-prereleased-drivers-note class=md-nav__link> Unsigned prereleased drivers note </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 본격적으로 시작! </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 인증서 만들기 / 설정 </a> <nav class=md-nav aria-label="인증서 만들기 / 설정"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#openssl class=md-nav__link> OpenSSL 설치 </a> </li> <li class=md-nav__item> <a href=#root-ca-certificate class=md-nav__link> '인증서 발급 기관' (Root CA Certificate) 생성 </a> </li> <li class=md-nav__item> <a href=#uefi class=md-nav__link> UEFI 플랫폼 키 인증서 인증서 만들기 </a> </li> <li class=md-nav__item> <a href=#uefi-pk class=md-nav__link> UEFI 펌웨어의 플랫폼 키(PK) 설정 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 커널 모드 드라이버 인증서 만들기 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sign-policy-si-policy class=md-nav__link> 서명 정책(Sign Policy; Si Policy) 설정 </a> </li> <li class=md-nav__item> <a href=#custom-kernel-signercks class=md-nav__link> Custom Kernel Signer(CKS) 켜기 </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 참고 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../windows-self-driver-signing-en/ class=md-nav__link> <span class=md-ellipsis> Self-signing on Windows </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 왜? </a> </li> <li class=md-nav__item> <a href=#unsigned-prereleased-drivers-note class=md-nav__link> Unsigned prereleased drivers note </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 본격적으로 시작! </a> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 인증서 만들기 / 설정 </a> <nav class=md-nav aria-label="인증서 만들기 / 설정"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#openssl class=md-nav__link> OpenSSL 설치 </a> </li> <li class=md-nav__item> <a href=#root-ca-certificate class=md-nav__link> '인증서 발급 기관' (Root CA Certificate) 생성 </a> </li> <li class=md-nav__item> <a href=#uefi class=md-nav__link> UEFI 플랫폼 키 인증서 인증서 만들기 </a> </li> <li class=md-nav__item> <a href=#uefi-pk class=md-nav__link> UEFI 펌웨어의 플랫폼 키(PK) 설정 </a> </li> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 커널 모드 드라이버 인증서 만들기 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#sign-policy-si-policy class=md-nav__link> 서명 정책(Sign Policy; Si Policy) 설정 </a> </li> <li class=md-nav__item> <a href=#custom-kernel-signercks class=md-nav__link> Custom Kernel Signer(CKS) 켜기 </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 참고 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=_1>윈도우에서 직접 드라이버 서명하기<a class=headerlink href=#_1 title="Permanent link">&para;</a></h1> <p>Note: <a href=windows-self-driver-signing-en>English version available</a>.</p> <div class="admonition warning"> <p class=admonition-title><strong>안내</strong></p> <p>이 글을 따라하기 전에 충분히 찾아보고 하세요. 필자는 어떤 문제도 보장하지 않습니다.<br> 이 글은 상세한 설명서가 아니라, 그냥 제가 어떤 삽질을 했는지(는 좀 생략됐지만), 어떻게 성공했는지를 기록한 글입니다. 반드시 더 깔끔한 방법이 있을 겁니다.</p> </div> <div class="admonition warning"> <p class=admonition-title><strong>안내 2</strong></p> <p>이걸 따라하면 안전할 거라고 보장하지 않습니다. 사실 이대로 하면 실제로 안전한지 위험한지도 모릅니다.. 어쩌면 testsigning보다 더 보안상 나쁠 수도 있습니다.</p> </div> <h2 id=_2>왜?<a class=headerlink href=#_2 title="Permanent link">&para;</a></h2> <p>온라인 수업을 하면서 마이크로 장난(...)을 좀 쳐보고 싶어졌습니다. 그리고 평소에 음악을 들을 때 FL 같은 DAW로 소리를 직접 보정해서 들었는데, 오디오 스펙트럼을 보면 좀 간지나기 때문에...</p> <p>아무튼 이러한 짓거리에는 필수적으로 필요했던 게 바로 가상 오디오 장치였는데 이미 나와있는 것들은 아래와 같았고 모두 만족스럽지 않았어요.</p> <ul> <li> <p><strong>VB Audio Cable</strong><br> 무료 체험판의 경우 케이블 1개만 사용 가능. <code>온라인 수업을 하며 마이크로 장난</code>과 <code>음악 보정</code> 둘 다 하려면 케이블이 적어도 2개는 있어야 했다.</p> </li> <li> <p><strong>ODeus ASIO Link Pro</strong><br> ... 그냥 이거 쓸까?<br> 디자인이 마음에 안들었다.</p> </li> <li> <p><strong>Virtual Audio Cable</strong><br> 엄청 좋아보이는데 유료임.</p> </li> </ul> <p>그러다가 Synchronous Audio Router(SAR)이라는 프로그램을 발견했어요. 사실 오디오를 라우팅하거나 보정하는 거는 FL로 하면 되기 때문에 전혀 문제가 되지 않았습니다. SAR은</p> <ul> <li>동적으로 가상 오디오 장치 추가 (무제한! 그냥 윈도우가 버텨주는 한 계속 만들 수 있음)</li> <li>무료, 오픈소스임</li> <li>그냥 마음에 듦</li> <li>성능이 좋은 편임</li> </ul> <p>이러했고, 그래서 SAR을 설치하기로 마음을 먹었는데...</p> <blockquote> <h2 id=unsigned-prereleased-drivers-note>Unsigned prereleased drivers note<a class=headerlink href=#unsigned-prereleased-drivers-note title="Permanent link">&para;</a></h2> <p>Prereleases of SAR are unsigned. That means that it is required to enable testsigning boot option to make Windows load the driver. Else the driver won't be loaded.</p> </blockquote> <p>이 시점에, UEFI 설정에서 Secure Boot를 켜놨었고 곧 윈도우 11로 업그레이드할 계획이었습니다. 그리고 보안을 고려하기도 했기 때문에 <code>testsigning</code> 부트 설정을 켜는 건 가능한 선택이 아니었습니다.</p> <p>그러다가 <a href=https://github.com/eiz/SynchronousAudioRouter/issues/86>어느 한 이슈</a>를 보게 되었는데</p> <blockquote> <p>UPDATE 3: SUCCESS!!!!!!!!! I am running the latest SAR in Reaper as we speak on windows 10 without testmode.</p> </blockquote> <p>어떤 사람이 성공했다고 해요. 그래서 저도 해보기로 했답니다. ㅋㅋㅋㅋㅋㅋㅋㅋ 벌써부터 험난해보이는...</p> <h2 id=_3>본격적으로 시작!<a class=headerlink href=#_3 title="Permanent link">&para;</a></h2> <p>제가 참조한 문서들은 저기 말한 '어느 한 이슈'에 설명되어 있는 방법을 (아주 많이) 변형해서 OpenSSL을 쓴 방법이었어요. 설명이 아주 불친절하더라고요. 실제로 불친절한지는 모르겠지만 (하지만 <code>its confusing and you have to jump back and forth between his guide and an older one</code> 라는 말이 있었다만) 제가 한국인이란 점을 감안하면..</p> <ul> <li>시작하기 전에 자신의 기기에서 <strong>UEFI 플랫폼 키</strong>를 설정하는 방법이 있는지, 어떻게 하는지를 미리 알아보기를 권장합니다. UEFI가 지원하지 않는다면 이걸 할 수가 없습니다.</li> <li>이 문서에서는 UEFI의 플랫폼 키를 설정하거나, EFI 부트 파티션을 건드리고 윈도우 레지스트리를 수정하는 등의 위험한 짓을 아주 많이 합니다. 필요하다면 백업을 해두길 권장합니다. <del>라고 해놓고 본인은 백업 안함</del></li> </ul> <div class="admonition info"> <p class=admonition-title><strong>참고</strong></p> <p>일단 이걸 하기 전에 위에 참조한 이슈랑 <a href=https://github.com/valinet/ssde>거기서 참조하는 이 리포</a>는 한번 훑어보시는 걸 추천드립니다.</p> </div> <h2 id=_4>인증서 만들기 / 설정<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <p>인증서를 만드는 방법은 <a href=https://github.com/HyperSine/Windows10-CustomKernelSigners/blob/master/asset/build-your-own-pki.md>이 문서에 잘 설명되어 있습니다</a>. 하지만 저 방법대로 했더니 내 UEFI(Dell임)가 인증서를 뱉길래 OpenSSL을 써서 다시 시도해보았습니다. (이제와서 보니 다시 시도할 필요가 있는지는 의문이지만...)</p> <p>우리가 할 것은 이 기기에서 작동하는 인증서를 만드는 것인데, 이 기기에서만 작동하는 '가상의 인증서 키 발급 기관' 같은 걸 만든 다음 그 기관의 인증서를 이용해서 <strong>UEFI 플랫폼 키 인증서</strong>와 <strong>커널 모드 드라이버 인증서</strong>를 만들 것입니다. 참고로 윈도우 11에서도 잘 된다고 합니다.</p> <p>파워셸을 <strong>관리자 권한으로 실행해주세요.</strong> (인증서 만들 때까지는 필요없는데 그 이후에 필요한 작업이 몇 개 있습니다.) 이 글은 파워셸을 기준으로 설명합니다. cmd라면 알아서 바꾸시길... (예를 들어 줄 끝에 <code>\</code> `가 있다면 그걸 지우고 다음줄과 합치면 된다.)</p> <p>아래의 지시사항을 다 따른다면 아래와 같은 파일 구조가 만들어집니다. <div class=highlight><pre><span></span><code>root-ca
<span class=k>-</span><span class=w> </span>private.key
<span class=k>-</span><span class=w> </span>cert-request.conf
<span class=k>-</span><span class=w> </span>cert-request.csr
<span class=k>-</span><span class=w> </span>cert.cer
<span class=k>-</span><span class=w> </span>serial.srl
platform-key
<span class=k>-</span><span class=w> </span>private.key
<span class=k>-</span><span class=w> </span>cert-request.conf
<span class=k>-</span><span class=w> </span>cert-request.csr
<span class=k>-</span><span class=w> </span>cert.cer
<span class=k>-</span><span class=w> </span>PK.unsigned.esl
<span class=k>-</span><span class=w> </span>PK.esl
<span class=k>-</span><span class=w> </span>PK.old.esl
kernel-mode
<span class=k>-</span><span class=w> </span>private.key
<span class=k>-</span><span class=w> </span>cert-request.conf
<span class=k>-</span><span class=w> </span>cert-request.csr
<span class=k>-</span><span class=w> </span>cert.cer
</code></pre></div></p> <h3 id=openssl>OpenSSL 설치<a class=headerlink href=#openssl title="Permanent link">&para;</a></h3> <p>깃을 설치할 때 기본값으로 OpenSSL이 번들되어 있는데, 그걸 쓰고싶다면 <a href=https://stackoverflow.com/a/51757939/10744716>이 StackOverflow 답변</a>을 참고하세요.</p> <p>저는 걍 깔고 싶어서 걍 깔았어요. Chocolatey가 깔려있는 사람이라면 관리자 권한 셸에서 <code class=highlight><span class=n>choco</span> <span class=n>install</span> <span class=n>openssl</span></code>을 치기만 하면 됩니다. 터미널을 껐다 켜기 싫으면 <code class=highlight><span class=n>refreshenv</span></code>만 치면 돼요.</p> <h3 id=root-ca-certificate>'인증서 발급 기관' (Root CA Certificate) 생성<a class=headerlink href=#root-ca-certificate title="Permanent link">&para;</a></h3> <p>어떤 Root CA 자체의 인증서가 신뢰된다면 그 CA가 발급한 다른 인증서도 마천가지로 신뢰될 것입니다. 예를 들어 WIZVERA라는 CA 인증기관을 믿을 수 있다면, 그 인증기관에서 발급한 인증서도 믿을 수 있는데요, 그래서 우리가 HTTPS 서명을 만들려면 어떤 인증서 발급기관에서 돈을 주고(물론 무료도 있지만) 인증서를 발급받는 것이에요.</p> <p><code>root-ca</code> 폴더를 만들고 아래 명령어를 실행하세요. <div class=highlight><pre><span></span><code><span class=nb>cd </span><span class=n>root-ca</span>

<span class=c># 비공개 키 생성하기</span>
<span class=n>openssl</span> <span class=n>genrsa</span> <span class=n>-aes256</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>2048</span>
</code></pre></div> 이 명령어를 설명해보자면,</p> <ul> <li><code>-aes256</code>: 생성되는 비공개 키를 암호화해서 보관함. 즉 암호를 암호화하는 옵션인 것. 비밀번호를 입력하는 게 귀찮다면 생략해도 되긴 한데 가능하면 설정하는 게 좋아요.</li> <li><code>-out private.key</code>: 'private.key'라는 파일로 내보냄.</li> <li><code>2048</code>: 키의 길이를 2048비트로.</li> </ul> <p>그 다음, 아래 내용을 복붙한 후 원하는 내용은 수정하고 <code>cert-request.conf</code>이라는 이름으로 저장하세요. countryName같은 것들은 수정하거나 지우지 말고, 대신 countryName_default같은 걸 수정하면 됩니다. <div class=highlight><pre><span></span><code><span class=na>[</span><span class=w> </span><span class=s>req ]</span>
<span class=na>default_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>2048</span>
<span class=na>default_md</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>sha256</span>
<span class=na>default_keyfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>private.key</span>
<span class=na>distinguished_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>localhost_root_ca</span>
<span class=na>extensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>v3_ca</span>
<span class=na>req_extensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>v3_ca</span>

<span class=na>[</span><span class=w> </span><span class=s>v3_ca ]</span>
<span class=na>basicConstraints</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>critical, CA:TRUE # , pathlen:0 # 이 옵션은 &#39;중간 CA&#39;의 최대 개수를 조절할 수 있다.</span>
<span class=na>subjectKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>hash</span>
<span class=na>keyUsage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>keyCertSign, cRLSign</span>

<span class=na>[</span><span class=w> </span><span class=s>localhost_root_ca ]</span>
<span class=na>countryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Country Name (2 letter code)</span>
<span class=na>countryName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span>

<span class=c1># 기관</span>
<span class=na>organizationName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organization Name (eg, company)</span>
<span class=na>organizationName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost</span>

<span class=c1># 기관 부서</span>
<span class=na>organizationalUnitName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organizational Unit Name (eg, section)</span>
<span class=na>organizationalUnitName_default</span><span class=w>  </span><span class=o>=</span><span class=w> </span>

<span class=c1># 이 인증서의 이름</span>
<span class=na>commonName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Common Name (eg, your name or your server&#39;s hostname)&quot;</span>
<span class=na>commonName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost Root Certification Authority</span>
</code></pre></div></p> <p>터미널로 돌아와서 아래 명령어를 입력해서 인증서 요청 파일(CSR)을 만들으세요. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>req</span> <span class=n>-new</span> <span class=n>-key</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-out</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=n>-config</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span>
</code></pre></div></p> <p>아래처럼 뜰 것입니다. <div class=highlight><pre><span></span><code>Enter pass phrase for private.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) []:
Organization Name (eg, company) [Localhost]:
Organizational Unit Name (eg, section) []:
Common Name (eg, your name or your server&#39;s hostname) [Localhost Root Certification Authority]:
</code></pre></div> 비밀번호를 입력하고, 나머지는 <code>cert-request.conf</code> 파일에서 설정했기 때문에 엔터를 연타해주면 자동으로 넘어갑니다.</p> <p>그럼 <code>cert-request.csr</code> 파일이 생겼을 것입니다. 아래의 명령어로 실제 인증서를 만들어줍니다. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>x509</span> <span class=n>-req</span> <span class=n>-days</span> <span class=n>18250</span> <span class=n>-extensions</span> <span class=n>v3_ca</span> <span class=p>`</span>
  <span class=n>-in</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=n>-signkey</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=p>`</span>
  <span class=n>-out</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span> <span class=n>-extfile</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span>
</code></pre></div></p> <ul> <li><code>-days 18250</code>에서 18250을 원하는 날짜로 수정해주면 됩니다. 18250일은 약 50년입니다. (정확하게는 365 * 50)</li> <li><code>-extensions v3_ca</code>는 cert-request.conf에서 <code>[ v3_ca ]</code>라는 부분에서 정보를 불러오도록 해줍니다</li> <li>나머지는 다 파일이름을 넣어주는 것입니다.</li> </ul> <p>이제 나온 <code>cert.cer</code> 파일을 윈도우에 박아줘야 합니다. 이 인증서를 더블클릭해서 열고 '인증서 설치' &gt; 저장소 위치를 '로컬 컴퓨터'로 &gt; '모든 인증서를 다음 저장소에 저장'에서 '찾아보기'의 '신뢰할 수 있는 루트 인증 기관(Trusted Root Certification Authority)'를 선택하고 설치하면 됩니다.</p> <p>이제 <strong>UEFI 플랫폼 키 인증서</strong>와 <strong>커널 모드 드라이버 인증서</strong>를 만들어봅시다.</p> <h3 id=uefi>UEFI 플랫폼 키 인증서 인증서 만들기<a class=headerlink href=#uefi title="Permanent link">&para;</a></h3> <p>상위 폴더에서 platform-key 폴더를 만들고 아래 코드를 실행합니다.</p> <div class=highlight><pre><span></span><code><span class=nb>cd </span><span class=p>../</span><span class=n>platform-key</span>

<span class=c># 개인키 생성</span>
<span class=n>openssl</span> <span class=n>genrsa</span> <span class=n>-aes256</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>2048</span>
</code></pre></div> <p>그 다음, 또 다시 이 폴더에 <code>cert-request.conf</code>를 만들고 복붙하세요.</p> <div class=highlight><pre><span></span><code><span class=na>[</span><span class=w> </span><span class=s>req ]</span>
<span class=na>default_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>2048</span>
<span class=na>default_md</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>sha256</span>
<span class=na>default_keyfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>private.key</span>
<span class=na>distinguished_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>localhost_uefi_platform_key</span>
<span class=na>extensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>v3_req</span>

<span class=na>[</span><span class=w> </span><span class=s>v3_req ]</span>
<span class=na>basicConstraints</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>CA:FALSE</span>
<span class=na>authorityKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>keyid, issuer</span>
<span class=na>subjectKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>hash</span>
<span class=na>keyUsage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>digitalSignature</span>

<span class=na>[</span><span class=w> </span><span class=s>localhost_uefi_platform_key ]</span>
<span class=na>countryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Country Name (2 letter code)</span>
<span class=na>countryName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span>

<span class=c1># 기관</span>
<span class=na>organizationName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organization Name (eg, company)</span>
<span class=na>organizationName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost</span>

<span class=c1># 기관 부서</span>
<span class=na>organizationalUnitName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organizational Unit Name (eg, section)</span>
<span class=na>organizationalUnitName_default</span><span class=w>  </span><span class=o>=</span><span class=w> </span>

<span class=c1># 이 인증서의 이름</span>
<span class=na>commonName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Common Name (eg, your name or your server&#39;s hostname)&quot;</span>
<span class=na>commonName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost UEFI Platform Key Certificate</span>
</code></pre></div> <p>아래 명령어로 인증서 발급 요청(CSR) 파일을 만듭니다. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>req</span> <span class=n>-new</span> <span class=n>-key</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-out</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=n>-config</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span>
</code></pre></div> 마천가지로 비번을 입력하고, 엔터를 연타해줍니다.</p> <p>이제 인증서를 만들도록 하겠습니다. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>x509</span> <span class=n>-req</span> <span class=n>-days</span> <span class=n>18250</span> <span class=n>-extensions</span> <span class=n>v3_req</span> <span class=p>`</span>
  <span class=n>-in</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=p>`</span>
  <span class=n>-CA</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>cert</span><span class=p>.</span><span class=n>cer</span> <span class=n>-CAcreateserial</span> <span class=n>-CAserial</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>serial</span><span class=p>.</span><span class=n>srl</span> <span class=p>`</span>
  <span class=n>-CAkey</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=p>`</span>
  <span class=n>-extfile</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span> <span class=n>-out</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span>
</code></pre></div></p> <ul> <li><code>-CA ...</code>: CA 인증서의 경로</li> <li><code>-CAkey ...</code>: CA 비공개 키의 경로</li> <li><code>-CAcreateserial -CAserial ../root-ca/serial.srl</code>: serial 파일을 만들고 serial.srl 파일에 저장. 이 루트 인증서로 만드는 인증서들의 시리얼 넘버가 겹치지 않게 해줍니다. 만약 이 명령어를 여러번 실행할 때에는 serial.srl 파일이 이미 있기 때문에 <code>-CAcreateserial</code>은 빼야 합니다.</li> </ul> <p>추가로, 나중에 윈도우 드라이버나 'Si Policy'를 서명할 때 필요하기 때문에(signtool을 쓰기 위해) private.key를 .pfx 파일로 변환해줘야 합니다.</p> <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>pkcs12</span> <span class=n>-export</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>pfx</span> <span class=n>-inkey</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-in</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span>
</code></pre></div> <h3 id=uefi-pk>UEFI 펌웨어의 플랫폼 키(PK) 설정<a class=headerlink href=#uefi-pk title="Permanent link">&para;</a></h3> <p><img alt="Set-SecureBootUefi success" src=../ssd/set-securebootuefi.png> <em><p align=center>지린다</p></em></p> <p>여기서는 본인의 컴퓨터마다 쓸 수 있는 방법이 상이합니다. 저의 경우 Dell 노트북이었는데, UEFI 설정에 'Expert Key Management'라는 PK를 설정할 수 있는 곳이 있었는데 결론적으로는 아주 잘 작동하지 않았습니다. 무언가가 심하게 고장난 듯? 하지만! 파워셸 명령어인 <code class=highlight>Set-SecureBootUefi</code>을 써서 작동하게 했습니다.</p> <p>일단 한번에 키를 다 만들어놓고 이걸 하고 싶다면 아래 문단 '커널 모드 드라이버 인증서 만들기'를 먼저 해도 됩니다. 다만 다 만들어놓고 설정을 못한다면 상실감이 클테니 이걸 먼저 하는 것을 권장합니다.</p> <p>우선 본인 UEFI 설정에서 이걸 정하는 기능이 있는지 확인해보고, 있다면 그 방법을 시도해보세요.<br> 이 방법도 UEFI에 따라 될 수도, 안될 수도 있습니다.</p> <p>필자는 아래의 파워셸 명령어로 설정하는 방법을 쓸 때 <a href=https://docs.microsoft.com/windows/wsl/about>WSL</a>을 통해 <code>efitools</code>를 설치해서 했습니다. 사실 저 efitools의 윈도우용 대안을 찾지 못해서 이렇게 한 것인데. 만약 대안을 찾았다면 이 문서에 PR 좀...</p> <p><strong>이 방법을 시도하기 전에 UEFI 설정에서 Secure Boot Mode를 적당하게 바꿔주세요.</strong> 기본 모드에서는 PK 같은 키들을 바꾸지 못하게 막아놨습니다. 제 UEFI(Dell)의 경우 'Deploy Mode'와 'Audit Mode'가 있었는데 Audit Mode로 바꾸고 아래 명령어를 실행하니 됐습니다.</p> <p>일단 WSL 터미널로 들어갑니다.</p> <p><div class=highlight><pre><span></span><code><span class=c1># platform-key 폴더로 이동</span>
<span class=nb>cd</span><span class=w> </span><span class=k>$(</span>wslpath<span class=w> </span><span class=s2>&quot;platform-key 폴더의 경로&quot;</span><span class=k>)</span>

<span class=c1># esl 파일 생성</span>
cert-to-efi-sig-list<span class=w> </span>-g<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>cat<span class=w> </span>/proc/sys/kernel/random/uuid<span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>cert.cer<span class=w> </span>PK.unsigned.esl

<span class=c1># esl 파일 서명</span>
sign-efi-sig-list<span class=w> </span>-k<span class=w> </span>private.key<span class=w> </span>-c<span class=w> </span>cert.cer<span class=w> </span>PK<span class=w> </span>PK.unsigned.esl<span class=w> </span>PK.esl
</code></pre></div> 참고로 .esl 파일은 EFI Signature List의 약자로, UEFI 펌웨어에서 서명을 저장하는 방식의 일부입니다. esl 파일을 서명하면 보안이 더 좋으려나?</p> <p>설정하기 전에 esl 파일을 백업합시다. <div class=highlight><pre><span></span><code><span class=nb>Get-SecureBootUefi</span> <span class=n>-Name</span> <span class=n>PK</span> <span class=n>-OutputFilePath</span> <span class=n>PK</span><span class=p>.</span><span class=n>old</span><span class=p>.</span><span class=n>esl</span>
</code></pre></div></p> <p>그 다음 <strong>관리자 권한으로</strong> 파워셸을 열고(이미 관리자 권한이면 새로 열지 않아도 됩니다.) platform-key 폴더로 이동한 후 아래 명령어를 입력합니다.</p> <div class=highlight><pre><span></span><code><span class=nb>Set-SecureBootUEFI</span> <span class=n>-Name</span> <span class=n>PK</span> <span class=n>-SignedFilePath</span> <span class=n>PK</span><span class=p>.</span><span class=n>esl</span> <span class=n>-ContentFilePath</span> <span class=n>PK</span><span class=p>.</span><span class=n>unsigned</span><span class=p>.</span><span class=n>esl</span> <span class=n>-Time</span> <span class=p>$(</span><span class=nb>Get-Date</span><span class=p>)</span>
</code></pre></div> <p>만약 <code>Set-SecureBootUEFI: 잘못된 인증 데이터: 0xC0000022</code>라고 뜬다면 키를 잘못 넣어줬거나, Secure Boot Mode를 바꾸지 않았거나, UEFI가 지원하지 않는 거에요.<br> 만약 성공했다면, 축하합니다. 이제 컴퓨터의 UEFI는 우리의 인증서 발급 기관(CA)을 신뢰할 거에요.</p> <p>추가: 노트북을 바꾸게 되어서 삼성 갤럭시 북에서 다시 한번 시도해봤어요. 여기서는 Audit Mode/Deploy Mode 같은 구분이 없고, 바이오스 설정에서 직접 키를 바꾸게 되어있더라고요. 그런데 드라이브 목록에서 D: 드라이브가 안뜨길래 이유를 생각해봤는데 파티션 목록들을 보니 딱 FAT32 형식의 파티션만 뜨는 것 같더라고요. 그래서 USB 꽂기는 귀찮았고 D 드라이브를 shrink하고, 그 디스크에서 자그만 파티션 하나를 파고 FAT32로 포맷하고 마운트해서 키를 넣어놓은 다음 다시 바이오스 설정에 들어가니까 뜨더라고요.</p> <h3 id=_5>커널 모드 드라이버 인증서 만들기<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>상위 폴더에서 kernel-mode-driver 폴더를 만들고 아래 코드를 실행합니다.</p> <div class=highlight><pre><span></span><code><span class=nb>cd </span><span class=p>../</span><span class=n>kernel-mode-driver</span>

<span class=c># 개인키 생성</span>
<span class=n>openssl</span> <span class=n>genrsa</span> <span class=n>-aes256</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>2048</span>
</code></pre></div> <p>그 다음, 또또 다시 이 폴더에 <code>cert-request.conf</code>를 만들고 복붙 ㄱㄱ</p> <div class=highlight><pre><span></span><code><span class=na>[</span><span class=w> </span><span class=s>req ]</span>
<span class=na>default_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>2048</span>
<span class=na>default_md</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>sha256</span>
<span class=na>default_keyfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>private.key</span>
<span class=na>distinguished_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>localhost_kernel_mode_driver</span>
<span class=na>extensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>v3_req</span>

<span class=na>[</span><span class=w> </span><span class=s>v3_req ]</span>
<span class=na>basicConstraints</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>CA:FALSE</span>
<span class=na>authorityKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>keyid, issuer</span>
<span class=na>subjectKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>hash</span>
<span class=na>keyUsage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>digitalSignature</span>
<span class=na>extendedKeyUsage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>codeSigning</span>

<span class=na>[</span><span class=w> </span><span class=s>localhost_kernel_mode_driver ]</span>
<span class=na>countryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Country Name (2 letter code)</span>
<span class=na>countryName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span>

<span class=c1># 기관</span>
<span class=na>organizationName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organization Name (eg, company)</span>
<span class=na>organizationName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost</span>

<span class=c1># 기관 부서</span>
<span class=na>organizationalUnitName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organizational Unit Name (eg, section)</span>
<span class=na>organizationalUnitName_default</span><span class=w>  </span><span class=o>=</span><span class=w> </span>

<span class=c1># 이 인증서의 이름</span>
<span class=na>commonName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Common Name (eg, your name or your server&#39;s hostname)&quot;</span>
<span class=na>commonName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost Kernel Mode Driver Certificate</span>
</code></pre></div> <p>아래 명령어로 인증서 발급 요청(CSR) 파일을 만들어 주세요. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>req</span> <span class=n>-new</span> <span class=n>-key</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-out</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=n>-config</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span>
</code></pre></div> 마천가지로 비번을 입력하고, 엔터를 연타해 줍니다.</p> <p>이제 인증서를 만듭니다. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>x509</span> <span class=n>-req</span> <span class=n>-days</span> <span class=n>18250</span> <span class=n>-extensions</span> <span class=n>v3_req</span> <span class=p>`</span>
  <span class=n>-in</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=p>`</span>
  <span class=n>-CA</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>cert</span><span class=p>.</span><span class=n>cer</span> <span class=n>-CAserial</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>serial</span><span class=p>.</span><span class=n>srl</span> <span class=p>`</span>
  <span class=n>-CAkey</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=p>`</span>
  <span class=n>-extfile</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span> <span class=n>-out</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span>
</code></pre></div></p> <ul> <li><code>-CAserial ../root-ca/serial.srl</code>: 만약 이 명령어를 위의 UEFI 플랫폼 키를 만들기 전에 실행할 때에는 serial.srl 파일이 없기 때문에 <code>-CAcreateserial</code>을 붙여야 합니다.</li> </ul> <p>한번 더, 나중에 윈도우 드라이버나 'Si Policy'를 서명할 때 필요하기 때문에(signtool을 쓰기 위해) private.key를 .pfx 파일로 변환해줘야 합니다.</p> <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>pkcs12</span> <span class=n>-export</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>pfx</span> <span class=n>-inkey</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-in</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span>
</code></pre></div> <p>이제 필요한 세 인증서를 전부 만들어 보았습니다.</p> <h2 id=sign-policy-si-policy>서명 정책(Sign Policy; Si Policy) 설정<a class=headerlink href=#sign-policy-si-policy title="Permanent link">&para;</a></h2> <p><del>원래 서명 정책을 담은 xml 파일을 만든 후 바이너리 파일로 만들어야 했는데, 이건 윈도우 Enterprise/Education Edition에서만 할 수 있기 때문에 (근데 왜 내 컴퓨터에선 되지) <a href=https://www.geoffchappell.com/notes/windows/license/_download/sipolicy.zip>이미 만들어진 바이너리 파일을 다운받습니다.</a></del></p> <div class="admonition warning"> <p class=admonition-title>보안 경고!</p> <p><code>@ridingtheflow</code>님이 이 빌드된 SiPolicy 파일이 <em>모든 드라이버를 허용하는</em> 내용이라고 알려주셨습니다. 그리고, SiPolicy를 다운받는 것 자체가 위험할 수도 있습니다.<br> <code>New-CIPolicy</code>로 SiPolicy를 만드는 것도 위험할 수 있는데, 기본적으로 <code>Event:Audit Mode</code>라는 디버깅용 모드가 켜진 상태이기 때문입니다.</p> </div> <p>이제 <code>selfsign.bin</code>을 서명해야 윈도우에서 정상적으로 인식하게 됩니다.</p> <div class=highlight><pre><span></span><code><span class=n>signtool</span> <span class=n>sign</span> <span class=p>/</span><span class=n>fd</span> <span class=n>sha256</span> <span class=p>/</span><span class=n>p7co</span> <span class=n>1</span><span class=p>.</span><span class=n>3</span><span class=p>.</span><span class=n>6</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>4</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>311</span><span class=p>.</span><span class=n>79</span><span class=p>.</span><span class=n>1</span> <span class=p>/</span><span class=n>p7</span> <span class=p>.</span> <span class=p>/</span><span class=n>f</span> <span class=n>platform-key</span><span class=p>/</span><span class=n>private</span><span class=p>.</span><span class=n>pfx</span> <span class=p>/</span><span class=n>p</span> <span class=cm>&lt;# platform-key의 비밀번호 #&gt;</span> <span class=n>sipolicy</span><span class=p>/</span><span class=n>selfsign</span><span class=p>.</span><span class=n>bin</span>
</code></pre></div> <ul> <li><code>platform-key/private.key</code>: platform key의 비공개 키 경로</li> <li><code>sipolicy/selfsign.bin</code>: 바로 위에서 다운받은 파일</li> </ul> <p>이제 <code>selfsign.bin.p7</code>이라는 파일이 생겼을 것입니다. 파일의 이름을 <code>SiPolicy.p7b</code>로 바꿔주세요. 그 다음 <strong>관리자 권한으로</strong> 파워셸을 열고(이미 관리자 권한이면 새로 열지 않아도 됩니다.) 아래 명령어를 실행해주세요.</p> <div class=highlight><pre><span></span><code><span class=c># EFI 시스템 파티션을 X: 드라이브에 마운트</span>
<span class=n>mountvol</span> <span class=n>x</span><span class=p>:</span> <span class=p>/</span><span class=n>s</span>

<span class=c># SiPolicy 복사</span>
<span class=nb>cp </span><span class=n>SiPolicy</span><span class=p>.</span><span class=n>p7b</span> <span class=n>X</span><span class=p>:\</span><span class=n>EFI</span><span class=p>\</span><span class=n>Microsoft</span><span class=p>\</span><span class=n>Boot</span><span class=p>\</span>

<span class=c># (안해도 상관은 없음?) EFI 볼륨 마운트해뒀던거 취소하기</span>
<span class=n>mountvol</span> <span class=n>x</span><span class=p>:</span> <span class=p>/</span><span class=n>d</span>
</code></pre></div> <h2 id=custom-kernel-signercks>Custom Kernel Signer(CKS) 켜기<a class=headerlink href=#custom-kernel-signercks title="Permanent link">&para;</a></h2> <p>CKS라는 이 값은 레지스트리의 <code>HKLM\SYSTEM\CurrentControlSet\Control\ProductOptions</code>에 저장되어 있다고 합니다. 이 값은 사실상 커널 초기화가 끝나지 않았을 때에만 설정할 수 있는데요, 자세한 원리는 <a href=https://github.com/HyperSine/Windows10-CustomKernelSigners>원본 문서에서 확인할 수 있습니다</a>. 저는 방법만 간단하게 설명할게요.</p> <p><a href=https://github.com/valinet/ssde/releases>우선 이 url로 들어가서 ssde.zip을 받아주세요</a>. 거기 안에 보면 ssde.sys가 있습니다. 이 드라이버를 서명해줄 건데요, 아래 명령어를 실행해주세요.</p> <div class=highlight><pre><span></span><code><span class=n>signtool</span> <span class=n>sign</span> <span class=p>/</span><span class=n>fd</span> <span class=n>sha256</span> <span class=p>/</span><span class=n>a</span> <span class=p>/</span><span class=nb>ac </span><span class=n>root-ca</span><span class=p>/</span><span class=n>cert</span><span class=p>.</span><span class=n>cer</span> <span class=p>/</span><span class=n>f</span> <span class=n>kernel-mode-driver</span><span class=p>/</span><span class=n>private</span><span class=p>.</span><span class=n>pfx</span> <span class=p>/</span><span class=n>p</span> <span class=p>&lt;</span><span class=n>비밀번호</span><span class=p>&gt;</span> <span class=p>/</span><span class=n>td</span> <span class=n>sha256</span> <span class=p>/</span><span class=n>tr</span> <span class=n>http</span><span class=p>://</span><span class=n>sha256timestamp</span><span class=p>.</span><span class=n>ws</span><span class=p>.</span><span class=n>symantec</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>sha256</span><span class=p>/</span><span class=n>timestamp</span> <span class=n>ssde</span><span class=p>.</span><span class=n>sys</span>
</code></pre></div> <p><strong>혹시 컴퓨터를 다시 못 켤까봐 두려우신 분들은 WinPE(Windows Preinstalled Environment)를 설정하는 것을 추천드립니다.</strong> 아래의 명령어를 실행한 후에는 윈도우 입장에서 ssde.sys가 알 수 없는 인증서로 서명되었는데, 커널 드라이버라서 실행을 못하여서 Kernel fault를 일으키게 됩니다. 즉 블루스크린이 뜨거나 복구 환경으로 들어가게 됩니다. 복구 환경으로 들어갈 수 있다면 다행이고, 아마 들어가질 겁니다. 하지만 만약 그렇지 않다면 다시 컴퓨터로 부팅할 수 없을지도 모르니까요?<br> 뭐 근데 아마 될거에요?</p> <p>이제 드디어 적용할 시간입니다. <strong>위에서 서명한</strong> ssde.sys를 설치해줄 겁니다. 아래 명령어를 관리자 권한 파워셸에서 실행해주세요. (cmd라면 <code class=highlight><span class=nv>$env:windir</span></code>을 <code class=highlight><span class=nv>%windir%</span></code>로 바꾸면 됩니다.)</p> <div class=highlight><pre><span></span><code><span class=nb>cp </span><span class=n>ssde</span><span class=p>.</span><span class=n>sys</span> <span class=nv>$env:windir</span><span class=p>\</span><span class=n>system32</span><span class=p>\</span><span class=n>drivers</span><span class=p>\</span><span class=n>ssde</span><span class=p>.</span><span class=n>sys</span>
<span class=n>sc</span><span class=p>.</span><span class=n>exe</span> <span class=n>create</span> <span class=n>ssde</span> <span class=n>binpath</span><span class=p>=</span><span class=nv>$env:windir</span><span class=p>\</span><span class=n>system32</span><span class=p>\</span><span class=n>drivers</span><span class=p>\</span><span class=n>ssde</span><span class=p>.</span><span class=n>sys</span> <span class=n>type</span><span class=p>=</span><span class=n>kernel</span> <span class=n>start</span><span class=p>=</span><span class=n>boot</span> <span class=n>error</span><span class=p>=</span><span class=n>normal</span>
</code></pre></div> <p>혹시나 아래에 있는 단계를 하다가 무언가 안돼서 원래대로 되돌리려면 복구모드 명령 프롬프트에서 그냥 <code>C:\Windows\System32\drivers\ssde.sys</code>를 삭제하면 원래대로 돌아옵니다. 혹시 UEFI 설정에서 PK를 초기화했다던가 컴퓨터 설정을 바꾸다가 초기화되면 부팅이 정상적으로 안 될수도 있는데 그때 이 방법을 쓰면 돼요.</p> <p><strong>아래 부분은 종이에 적어놓거나 휴대폰으로 보시는 걸 추천드립니다.</strong><br> 이제 컴퓨터를 재부팅하면 아마 평소와 다르게 블루스크린이 뜨거나 '시스템 복구 중' 같은 식으로 뜨다가 다른 창으로 넘어갈거에요. 이것은 부팅이 실패했고 커널 패닉이 일어났다는 뜻입니다. </p> <blockquote> <p>자동 복구에서 PC를 복구하지 못했습니다.</p> </blockquote> <p>이제 이 부분에서 <strong>고급 옵션</strong>으로 들어가고, <strong>문제 해결 &gt; 고급 옵션 &gt; 명령 프롬프트</strong>를 선택합니다. 계정을 선택하고 비번을 입력하면 cmd 창이 뜰겁니다. 여기서 <code class=highlight>regedit</code>을 입력하면 레지스트리 편집기가 뜹니다. <code>HKEY_LOCAL_MACHINE</code>을 선택한 다음 <code>파일(F)</code> &gt; <code>하이브 로드(L)...</code>을 누르고 윈도우가 설치된 경로에서 (보통 <code>C:/Windows</code>, 복구모드에선 다른 드라이브에 마운트됐을 수도 있어요) <code>System32 &gt; config &gt; SYSTEM</code>을 열어서 아무 이름 입력, 확인을 누릅니다. 그럼 <code>HKEY_LOCAL_MACHINE</code> 아래에 해당 '아무 이름'이라는 키가 뜰거에요.</p> <p>해당 키에서 <code>ControlSet001</code> &gt; <code>Control</code> &gt; <code>CI</code> &gt; <code>Protected</code>에 보면 <code>Licensed</code>라는 게 보일 거에요. 더블클릭해서 <strong>기존의 값 0을 1로 바꾸고</strong> 확인을 눌러줍니다.</p> <p><img alt=set-licensed src=../ssd/set-licensed.jpg> 이렇게요.</p> <p>이제 할 일을 끝마쳤습니다. 레지스트리 편집기와 cmd 창을 닫고 다시 부팅을 하면 아마 정상적으로 될 거에요. 이제 ssde.zip을 풀은 폴더에 보면 ssde_info.exe라는 프로그램이 있는데 cmd나 파워셸에서 실행시켜 주세요. 무언가 오류가 아닌 것처럼 생긴 게 아래처럼 뜨면 성공입니다.</p> <p><div class=highlight><pre><span></span><code>API version is 1.1
Arm count is 2
Arm watchdog status is 1
License tamper state is 0
</code></pre></div> 이 드라이버도 우리가 만든 인증서로 서명했기 때문에, 정상적으로 실행됐다면 거의 다 끝났습니다.</p> <p>이제 컴퓨터를 다시 시작해 보세요. '자동 복구에서 PC를 복구하지 못했습니다.'가 다시 뜰 가능성이 높습니다. 만약 안뜬다면 정상적으로 끝난 것이고, 만약 뜬다면 위에 설명한 것을 다시 실행하면 됩니다.</p> <p>수고하셨어요. 필요하다면 UEFI에서 Secure Boot Mode를 원래대로 돌려놓아도 됩니다. (PK를 설정하기 위해 잠시 바꿔놨었죠)</p> <p>추가: 새로 산 노트북에서 했을때는 이 방법이 잘 작동하지 않았습니다. 하지만 서비스 설치를 한 후, ssde_enable.exe를 실행해서 설정해놓은 다음 다시 시작 -&gt; 복구모드 진입 -&gt; 레지스트리 편집 -&gt; 다시 시작 -&gt; (cmd창 뜸, 자동으로 설정)의 과정을 거치니 잘 작동하더라고요.</p> <h2 id=_6>참고<a class=headerlink href=#_6 title="Permanent link">&para;</a></h2> <p>기본적으로 참고한 문서:</p> <ul> <li><a href=https://github.com/valinet/ssde>안정적인 방법: valinet/ssde</a></li> <li><a href=https://github.com/HyperSine/Windows10-CustomKernelSigners>최초로 성공한 사례: HyperSine/Windows10-CustomKernelSigners</a></li> <li><a href=https://www.geoffchappell.com/notes/windows/license/customkernelsigners.htm>원본 PoC: Licensed Driver Signing in Windows 10</a></li> </ul> <p>조금 유용한 문서들:</p> <ul> <li><a href=https://media.defense.gov/2020/Sep/15/2002497594/-1/-1/0/CTR-UEFI-Secure-Boot-Customization-UOO168873-20.PDF>미국 국방부에서 Secure Boot에 관해 쓴 글</a></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; lhwdev 2021. See <a href=https://github.com/lhwdev/note/tree/master/LICENSE>License</a>. </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.dff1b7c8.min.js></script> </body> </html>