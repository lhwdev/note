<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Where I write what I want to write"><meta name=author content=lhwdev><link href=http://lhwdev.github.io/note/other/windows-self-driver-signing-en/ rel=canonical><link href=../windows-self-driver-signing/ rel=prev><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.2, mkdocs-material-9.3.1"><title>Self-signing on Windows - Note</title><link rel=stylesheet href=../../assets/stylesheets/main.046329b4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.85d0ee34.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Note - Self-signing on Windows"><meta property=og:description content="Where I write what I want to write"></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#self-signing-on-windows class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=Note class="md-header__button md-logo" aria-label=Note data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Note </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Self-signing on Windows </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lhwdev/note title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=Note class="md-nav__button md-logo" aria-label=Note data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Note </label> <div class=md-nav__source> <a href=https://github.com/lhwdev/note title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../making/ class=md-nav__link> <span class=md-ellipsis> Making this site </span> </a> </li> <li class=md-nav__item> <a href=../../debug-page/ class=md-nav__link> <span class=md-ellipsis> Debug page </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> 고등학교 개발 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 고등학교 개발 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../high/covid-selftest-macro/ class=md-nav__link> <span class=md-ellipsis> 코로나19 자가진단 매크로를 만들며 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Android </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../android/transparent-status-bar/ class=md-nav__link> <span class=md-ellipsis> Transparent status bar in Android </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Kotlin Compiler Plugin </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Kotlin Compiler Plugin </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kotlin-compiler-plugin/backend-ir/ class=md-nav__link> <span class=md-ellipsis> Writing a Kotlin Backend IR Compiler Plugin </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Jetpack compose </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=false> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Jetpack compose </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../compose/how-it-works/ class=md-nav__link> <span class=md-ellipsis> How Compose Works </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8 checked> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Other </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=true> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Other </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../windows-self-driver-signing/ class=md-nav__link> <span class=md-ellipsis> 윈도우에서 직접 드라이버 서명하기 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> Self-signing on Windows </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> Self-signing on Windows </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#why class=md-nav__link> Why? </a> </li> <li class=md-nav__item> <a href=#unsigned-prereleased-drivers-note class=md-nav__link> Unsigned prereleased drivers note </a> </li> <li class=md-nav__item> <a href=#get-started class=md-nav__link> Get started </a> </li> <li class=md-nav__item> <a href=#creating-certificates-configuration class=md-nav__link> Creating Certificates &amp; Configuration </a> <nav class=md-nav aria-label="Creating Certificates & Configuration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#installing-openssl class=md-nav__link> Installing OpenSSL </a> </li> <li class=md-nav__item> <a href=#creating-root-ca-certificate class=md-nav__link> Creating Root CA Certificate </a> </li> <li class=md-nav__item> <a href=#creating-uefi-platform-keypk-certificate class=md-nav__link> Creating UEFI Platform Key(PK) Certificate </a> </li> <li class=md-nav__item> <a href=#setting-platform-key-of-uefi-firmware class=md-nav__link> Setting Platform Key of UEFI Firmware </a> </li> <li class=md-nav__item> <a href=#creating-kernel-mode-driver-certificate class=md-nav__link> Creating Kernel Mode Driver Certificate </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#setting-signing-policy-si-policy class=md-nav__link> Setting Signing Policy (Si Policy) </a> </li> <li class=md-nav__item> <a href=#turning-on-custom-kernel-signercks class=md-nav__link> Turning on Custom Kernel Signer(CKS) </a> </li> <li class=md-nav__item> <a href=#reference class=md-nav__link> Reference </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#why class=md-nav__link> Why? </a> </li> <li class=md-nav__item> <a href=#unsigned-prereleased-drivers-note class=md-nav__link> Unsigned prereleased drivers note </a> </li> <li class=md-nav__item> <a href=#get-started class=md-nav__link> Get started </a> </li> <li class=md-nav__item> <a href=#creating-certificates-configuration class=md-nav__link> Creating Certificates &amp; Configuration </a> <nav class=md-nav aria-label="Creating Certificates & Configuration"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#installing-openssl class=md-nav__link> Installing OpenSSL </a> </li> <li class=md-nav__item> <a href=#creating-root-ca-certificate class=md-nav__link> Creating Root CA Certificate </a> </li> <li class=md-nav__item> <a href=#creating-uefi-platform-keypk-certificate class=md-nav__link> Creating UEFI Platform Key(PK) Certificate </a> </li> <li class=md-nav__item> <a href=#setting-platform-key-of-uefi-firmware class=md-nav__link> Setting Platform Key of UEFI Firmware </a> </li> <li class=md-nav__item> <a href=#creating-kernel-mode-driver-certificate class=md-nav__link> Creating Kernel Mode Driver Certificate </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#setting-signing-policy-si-policy class=md-nav__link> Setting Signing Policy (Si Policy) </a> </li> <li class=md-nav__item> <a href=#turning-on-custom-kernel-signercks class=md-nav__link> Turning on Custom Kernel Signer(CKS) </a> </li> <li class=md-nav__item> <a href=#reference class=md-nav__link> Reference </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=self-signing-on-windows>Self-signing on Windows<a class=headerlink href=#self-signing-on-windows title="Permanent link">&para;</a></h1> <p>This document assumes that those reading this document has basic expertises for shell and programming. Even though I tried to explain as much as I can, it will not suffice for most people without extertises. If you are not, you may try these, but it will be... painstaking.<br> <a href=https://lhwdev.github.io/note/other/windows-self-driver-signing>Same document in Korean</a> is also available. Note that my english may be poor.</p> <div class="admonition warning"> <p class=admonition-title><strong>Alert</strong></p> <p>Get yourself informed enough. I do not guarantee if this would work.<br> This writing is the record of what I've done, rather than a comprehensive guide. kleene-way-to-do-this (better than mine) should be exist.</p> </div> <div class="admonition warning"> <p class=admonition-title><strong>Another Alert</strong></p> <p>Note that I do not know any security implications by this task. Steps below may be more harmful than just enabling testsigning. Know what you do.</p> </div> <h2 id=why>Why?<a class=headerlink href=#why title="Permanent link">&para;</a></h2> <p>I found Synchronous Audio Router(SAR) which can,</p> <ul> <li>add virtual audio device (UNLIMITED; as far as your Windows stands)</li> <li>FOSS</li> <li>just liked it</li> <li>high performance, low latency</li> </ul> <p>So I made up mind to install it. However...</p> <blockquote> <h2 id=unsigned-prereleased-drivers-note>Unsigned prereleased drivers note<a class=headerlink href=#unsigned-prereleased-drivers-note title="Permanent link">&para;</a></h2> <p>Prereleases of SAR are unsigned. That means that it is required to enable testsigning boot option to make Windows load the driver. Else the driver won't be loaded.</p> </blockquote> <p>At this point I'd turned Secure Boot and gotta upgrade to Windows 11. I also considered security, so turning on <code>testsigning</code> was not eligible.</p> <p>At that time I came across a comment from <a href=https://github.com/eiz/SynchronousAudioRouter/issues/86>one issue</a> saying:</p> <blockquote> <p>UPDATE 3: SUCCESS!!!!!!!!! I am running the latest SAR in Reaper as we speak on windows 10 without testmode.</p> </blockquote> <p>(lhwdev was determined!)</p> <h2 id=get-started>Get started<a class=headerlink href=#get-started title="Permanent link">&para;</a></h2> <ul> <li>Before you start, find ways to set <strong>UEFI Platform Key</strong> on your device. If your UEFI does not support this, you cannot do these all.</li> <li>This document covers a lot of dangerous things like 'setting UEFI Platform Key, editing EFI boot partition, modifying Windows system registry'. <strong>Recommend backup in advance</strong>. <del>(but the writer did not)</del></li> </ul> <div class="admonition info"> <p class=admonition-title><strong>Reference</strong></p> <p>If you want, take a look at that issue I began from, and <a href=https://github.com/valinet/ssde>the repo referenced from there</a>.</p> </div> <h2 id=creating-certificates-configuration>Creating Certificates &amp; Configuration<a class=headerlink href=#creating-certificates-configuration title="Permanent link">&para;</a></h2> <p>I used builtin powershell command <code class=highlight><span class=nb>New-SelfSignedCertificate</span></code> to create certificates first, but I came to use OpenSSL. If you want to use builtin things, you can follow <a href=https://github.com/HyperSine/Windows10-CustomKernelSigners/blob/master/asset/build-your-own-pki.md>this one</a> instead of openssl-related things.</p> <p>We are going to create certificates which is only valid on your device. (Virtual) Root Certificate Authority, (Root CA) and create other certs using it. These methods will work on Windows 11 AFAIK.</p> <p>Launch Powershell with <strong>admistrative privilege</strong>. (not needed to create certs; needed after that) This article is based on Powershell.</p> <p>The resulting files are like this: <div class=highlight><pre><span></span><code>root-ca
<span class=k>-</span><span class=w> </span>private.key
<span class=k>-</span><span class=w> </span>cert-request.conf
<span class=k>-</span><span class=w> </span>cert-request.csr
<span class=k>-</span><span class=w> </span>cert.cer
<span class=k>-</span><span class=w> </span>serial.srl
platform-key
<span class=k>-</span><span class=w> </span>private.key
<span class=k>-</span><span class=w> </span>cert-request.conf
<span class=k>-</span><span class=w> </span>cert-request.csr
<span class=k>-</span><span class=w> </span>cert.cer
<span class=k>-</span><span class=w> </span>PK.unsigned.esl
<span class=k>-</span><span class=w> </span>PK.esl
<span class=k>-</span><span class=w> </span>PK.old.esl
kernel-mode
<span class=k>-</span><span class=w> </span>private.key
<span class=k>-</span><span class=w> </span>cert-request.conf
<span class=k>-</span><span class=w> </span>cert-request.csr
<span class=k>-</span><span class=w> </span>cert.cer
</code></pre></div> You can rename as you want, but you need to use that name all through this guide.</p> <h3 id=installing-openssl>Installing OpenSSL<a class=headerlink href=#installing-openssl title="Permanent link">&para;</a></h3> <p>OpenSSL is bundled when installing Git, so to use it check out <a href=https://stackoverflow.com/a/51757939/10744716>this StackOverflow answer</a>.</p> <p>Those with Chocolatey installed can use <code class=highlight><span class=n>choco</span> <span class=n>install</span> <span class=n>openssl</span></code> in privileged shell. Use <code class=highlight><span class=n>refreshenv</span></code> to use new installed one without restarting shell. (bundled with choco)</p> <h3 id=creating-root-ca-certificate>Creating Root CA Certificate<a class=headerlink href=#creating-root-ca-certificate title="Permanent link">&para;</a></h3> <p>If the certificate of Root CA itself is trusted, certs that CA created will be trusted.</p> <p>Create <code>root-ca</code> directory, and run the following. <div class=highlight><pre><span></span><code><span class=nb>cd </span><span class=n>root-ca</span>

<span class=c># Generate private key</span>
<span class=n>openssl</span> <span class=n>genrsa</span> <span class=n>-aes256</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>2048</span>
</code></pre></div> Demonstration of this is:</p> <ul> <li><code>-aes256</code>: Encrypt the created private key. If you want to omit this you can, but it would be bad for security?</li> <li><code>-out private.key</code>: Into the file 'private.key'.</li> <li><code>2048</code>: The length of key.</li> </ul> <p>Then copy-paste below and save to <code>cert-request.conf</code>, modifying what you want. Do not modify things like countryName, (it does nothing) instead edit countryName_default, for instance.</p> <div class=highlight><pre><span></span><code><span class=na>[</span><span class=w> </span><span class=s>req ]</span>
<span class=na>default_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>2048</span>
<span class=na>default_md</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>sha256</span>
<span class=na>default_keyfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>private.key</span>
<span class=na>distinguished_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>localhost_root_ca</span>
<span class=na>extensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>v3_ca</span>
<span class=na>req_extensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>v3_ca</span>

<span class=na>[</span><span class=w> </span><span class=s>v3_ca ]</span>
<span class=na>basicConstraints</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>critical, CA:TRUE # , pathlen:0 # This option can adjust maximum number of &#39;intermediate CA&#39;.</span>
<span class=na>subjectKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>hash</span>
<span class=na>keyUsage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>keyCertSign, cRLSign</span>

<span class=na>[</span><span class=w> </span><span class=s>localhost_root_ca ]</span>
<span class=na>countryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Country Name (2 letter code)</span>
<span class=na>countryName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span>

<span class=na>organizationName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organization Name (eg, company)</span>
<span class=na>organizationName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost # or what you want?</span>

<span class=na>organizationalUnitName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organizational Unit Name (eg, section)</span>
<span class=na>organizationalUnitName_default</span><span class=w>  </span><span class=o>=</span><span class=w> </span>

<span class=na>commonName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Common Name (eg, your name or your server&#39;s hostname)&quot;</span>
<span class=na>commonName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost Root Certification Authority # or the name you want??</span>
</code></pre></div> <p>Return to shell, execute below to create Certificate Signing Request(CSR).</p> <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>req</span> <span class=n>-new</span> <span class=n>-key</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-out</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=n>-config</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span>
</code></pre></div> <p>You will see below. <div class=highlight><pre><span></span><code>Enter pass phrase for private.key:
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter &#39;.&#39;, the field will be left blank.
-----
Country Name (2 letter code) []:
Organization Name (eg, company) [Localhost]:
Organizational Unit Name (eg, section) []:
Common Name (eg, your name or your server&#39;s hostname) [Localhost Root Certification Authority]:
</code></pre></div> Enter the password (if you set), press enter repeatedly as we set default values in <code>cert-request.conf</code>.</p> <p>Now you can see <code>cert-request.csr</code>. Create actual cert with command below. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>x509</span> <span class=n>-req</span> <span class=n>-days</span> <span class=n>18250</span> <span class=n>-extensions</span> <span class=n>v3_ca</span> <span class=p>`</span>
  <span class=n>-in</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=n>-signkey</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=p>`</span>
  <span class=n>-out</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span> <span class=n>-extfile</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span>
</code></pre></div></p> <ul> <li>Replace 18250 in <code>-days 18250</code> with the duration you want the cert to be valid. Note that 18250 equals to approximately 50 years. (or 365 * 50)</li> <li><code>-extensions v3_ca</code> loads <code>[ v3_ca ]</code> part from .conf file you'd written.</li> <li>The left are file names.</li> </ul> <p>Now you need to register <code>cert.cer</code> to Windows so that it is trusted. Double click the cert created from above, <code>cert.cer</code>, and 'Install certificate...' &gt; 'Local Machine' &gt; 'Place all certificates in the following store', 'Browse... &gt; 'Trusted Root Certification Authorities'. Now if you open your cert, it will be shown as valid.</p> <p>Now let's create <strong>UEFI Platform Key Certificate</strong> and <strong>Kernel Mode Driver Certificate</strong>.</p> <h3 id=creating-uefi-platform-keypk-certificate>Creating UEFI Platform Key(PK) Certificate<a class=headerlink href=#creating-uefi-platform-keypk-certificate title="Permanent link">&para;</a></h3> <p>Move to the root directory we started, new folder 'platform-key', and run below.</p> <div class=highlight><pre><span></span><code><span class=nb>cd </span><span class=p>../</span><span class=n>platform-key</span>

<span class=c># Generate personal key</span>
<span class=n>openssl</span> <span class=n>genrsa</span> <span class=n>-aes256</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>2048</span>
</code></pre></div> <p>After, new file <code>cert-request.conf</code> and copy-paste, once more.</p> <div class=highlight><pre><span></span><code><span class=na>[</span><span class=w> </span><span class=s>req ]</span>
<span class=na>default_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>2048</span>
<span class=na>default_md</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>sha256</span>
<span class=na>default_keyfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>private.key</span>
<span class=na>distinguished_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>localhost_uefi_platform_key</span>
<span class=na>extensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>v3_req</span>

<span class=na>[</span><span class=w> </span><span class=s>v3_req ]</span>
<span class=na>basicConstraints</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>CA:FALSE</span>
<span class=na>authorityKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>keyid, issuer</span>
<span class=na>subjectKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>hash</span>
<span class=na>keyUsage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>digitalSignature</span>

<span class=na>[</span><span class=w> </span><span class=s>localhost_uefi_platform_key ]</span>
<span class=na>countryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Country Name (2 letter code)</span>
<span class=na>countryName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span>

<span class=na>organizationName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organization Name (eg, company)</span>
<span class=na>organizationName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost</span>

<span class=na>organizationalUnitName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organizational Unit Name (eg, section)</span>
<span class=na>organizationalUnitName_default</span><span class=w>  </span><span class=o>=</span><span class=w> </span>

<span class=na>commonName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Common Name (eg, your name or your server&#39;s hostname)&quot;</span>
<span class=na>commonName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost UEFI Platform Key Certificate</span>
</code></pre></div> <p>Create CSR file. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>req</span> <span class=n>-new</span> <span class=n>-key</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-out</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=n>-config</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span>
</code></pre></div> Enter the password and press enterrrrrr again.</p> <p>Let's make the certificate. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>x509</span> <span class=n>-req</span> <span class=n>-days</span> <span class=n>18250</span> <span class=n>-extensions</span> <span class=n>v3_req</span> <span class=p>`</span>
  <span class=n>-in</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=p>`</span>
  <span class=n>-CA</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>cert</span><span class=p>.</span><span class=n>cer</span> <span class=n>-CAcreateserial</span> <span class=n>-CAserial</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>serial</span><span class=p>.</span><span class=n>srl</span> <span class=p>`</span>
  <span class=n>-CAkey</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=p>`</span>
  <span class=n>-extfile</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span> <span class=n>-out</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span>
</code></pre></div></p> <ul> <li><code>-CA ...</code>: path to CA certificate (public key)</li> <li><code>-CAkey ...</code>: same (but private key)</li> <li><code>-CAcreateserial -CAserial ../root-ca/serial.srl</code>: Create serial file and save to serial.srl. This file let certificates made using CA never have serial numbers colliding. If serial.srl file already exists, you should exclude <code>-CAcreateserial</code> option.</li> </ul> <p>Additionally you should convert private.key to .pfx file as it is used from signtool to sign 'Si Policy'.</p> <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>pkcs12</span> <span class=n>-export</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>pfx</span> <span class=n>-inkey</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-in</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span>
</code></pre></div> <h3 id=setting-platform-key-of-uefi-firmware>Setting Platform Key of UEFI Firmware<a class=headerlink href=#setting-platform-key-of-uefi-firmware title="Permanent link">&para;</a></h3> <p><img alt="Set-SecureBootUefi success" src=../ssd/set-securebootuefi.png> <em><p align=center>Cool</p></em></p> <p>There are different ways depending on your device. My computer was Dell laptop, where there is 'Export Key Management', but it didn't work.<br> But I got it work by using powershell command <code class=highlight>Set-SecureBootUefi</code>.</p> <p>If you want to set PK after generating all the keys you can, but you might feel sense of lose(?) if your UEFI do not allow you to set PK.</p> <p>Check your UEFI setting first and try it if exists.</p> <p>In the method below using powershell, I used <code>efitools</code> through <a href=https://docs.microsoft.com/windows/wsl/about>WSL</a>. (but that command has some parameter like <code>-Hash</code>? I didn't try it) In fact I couldn't find alternative for efitools, so if you find one, PR this document.</p> <p><strong>Before trying methods below, change Secure Boot Mode in UEFI configuration.</strong> Changing keys like PK is blocked by default. For me, (Dell laptop) there were 'Deploy Mode' and 'Audit Mode'. Setting Secure Boot Mode to 'Audit Mode' made it work.</p> <p><strong>Get into WSL terminal.</strong></p> <p><div class=highlight><pre><span></span><code><span class=c1># Move to platform-key directory</span>
<span class=nb>cd</span><span class=w> </span><span class=k>$(</span>wslpath<span class=w> </span><span class=s2>&quot;path to platform-key/&quot;</span><span class=k>)</span>

<span class=c1># generate esl file</span>
cert-to-efi-sig-list<span class=w> </span>-g<span class=w> </span><span class=s2>&quot;</span><span class=k>$(</span>cat<span class=w> </span>/proc/sys/kernel/random/uuid<span class=k>)</span><span class=s2>&quot;</span><span class=w> </span>cert.cer<span class=w> </span>PK.unsigned.esl

<span class=c1># sign esl file</span>
sign-efi-sig-list<span class=w> </span>-k<span class=w> </span>private.key<span class=w> </span>-c<span class=w> </span>cert.cer<span class=w> </span>PK<span class=w> </span>PK.unsigned.esl<span class=w> </span>PK.esl
</code></pre></div> Note that .esl stands for EFI Signature List, which is a format to store signatures in UEFI firmware.</p> <p>Backup esl file in advance, just in case, <strong>from powershell</strong>. <div class=highlight><pre><span></span><code><span class=nb>Get-SecureBootUefi</span> <span class=n>-Name</span> <span class=n>PK</span> <span class=n>-OutputFilePath</span> <span class=n>PK</span><span class=p>.</span><span class=n>old</span><span class=p>.</span><span class=n>esl</span>
</code></pre></div></p> <p>Then open powershell with administrative privilege, (don't need to reopen if you are with) move to platform-key directory, and enter below.</p> <div class=highlight><pre><span></span><code><span class=nb>Set-SecureBootUEFI</span> <span class=n>-Name</span> <span class=n>PK</span> <span class=n>-SignedFilePath</span> <span class=n>PK</span><span class=p>.</span><span class=n>esl</span> <span class=n>-ContentFilePath</span> <span class=n>PK</span><span class=p>.</span><span class=n>unsigned</span><span class=p>.</span><span class=n>esl</span> <span class=n>-Time</span> <span class=p>$(</span><span class=nb>Get-Date</span><span class=p>)</span>
</code></pre></div> <p>If <code>Set-SecureBootUEFI: Invalid certification data: 0xC0000022</code> shows, you may put wrong key, may not change Secure Boot Mode, or your UEFI may not support it.<br> If you see something like below, congratulations. Our UEFI will trust our CA.</p> <div class=highlight><pre><span></span><code>Name Bytes                Attributes
---- -----                ----------
PK   {161, 89, 192, 18…} NON VOLATILE…
</code></pre></div> <p>APPENDIX: I've changed my laptop, so I tried this once again in 'Samsung Galaxy Book'. There was nothing like Audit Mode/Deploy Mode, (it seems they won't allow changing UEFI keys out of UEFI setup) but I could set PK in UEFI setup. It didn't show my D: drive, and came up that I can only select FAT32 partitions. I created new partition, copy PK file and finally I managed to set PK.</p> <h3 id=creating-kernel-mode-driver-certificate>Creating Kernel Mode Driver Certificate<a class=headerlink href=#creating-kernel-mode-driver-certificate title="Permanent link">&para;</a></h3> <p>New directory kernel-mode-driver from root, run this.</p> <div class=highlight><pre><span></span><code><span class=nb>cd </span><span class=p>../</span><span class=n>kernel-mode-driver</span>

<span class=c># generate personal key</span>
<span class=n>openssl</span> <span class=n>genrsa</span> <span class=n>-aes256</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>2048</span>
</code></pre></div> <p>Create <code>cert-request.conf</code> here again like this:</p> <div class=highlight><pre><span></span><code><span class=na>[</span><span class=w> </span><span class=s>req ]</span>
<span class=na>default_bits</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>2048</span>
<span class=na>default_md</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>sha256</span>
<span class=na>default_keyfile</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>private.key</span>
<span class=na>distinguished_name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>localhost_kernel_mode_driver</span>
<span class=na>extensions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>v3_req</span>

<span class=na>[</span><span class=w> </span><span class=s>v3_req ]</span>
<span class=na>basicConstraints</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>CA:FALSE</span>
<span class=na>authorityKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>keyid, issuer</span>
<span class=na>subjectKeyIdentifier</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>hash</span>
<span class=na>keyUsage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>digitalSignature</span>
<span class=na>extendedKeyUsage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>codeSigning</span>

<span class=na>[</span><span class=w> </span><span class=s>localhost_kernel_mode_driver ]</span>
<span class=na>countryName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Country Name (2 letter code)</span>
<span class=na>countryName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span>

<span class=na>organizationName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organization Name (eg, company)</span>
<span class=na>organizationName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost</span>

<span class=na>organizationalUnitName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Organizational Unit Name (eg, section)</span>
<span class=na>organizationalUnitName_default</span><span class=w>  </span><span class=o>=</span><span class=w> </span>

<span class=na>commonName</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Common Name (eg, your name or your server&#39;s hostname)&quot;</span>
<span class=na>commonName_default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>Localhost Kernel Mode Driver Certificate</span>
</code></pre></div> <p>Create CSR file. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>req</span> <span class=n>-new</span> <span class=n>-key</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-out</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=n>-config</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span>
</code></pre></div> Enter password, press enter a few times.</p> <p>Create certificate. <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>x509</span> <span class=n>-req</span> <span class=n>-days</span> <span class=n>18250</span> <span class=n>-extensions</span> <span class=n>v3_req</span> <span class=p>`</span>
  <span class=n>-in</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>csr</span> <span class=p>`</span>
  <span class=n>-CA</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>cert</span><span class=p>.</span><span class=n>cer</span> <span class=n>-CAserial</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>serial</span><span class=p>.</span><span class=n>srl</span> <span class=p>`</span>
  <span class=n>-CAkey</span> <span class=p>../</span><span class=n>root-ca</span><span class=p>/</span><span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=p>`</span>
  <span class=n>-extfile</span> <span class=n>cert-request</span><span class=p>.</span><span class=n>conf</span> <span class=n>-out</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span>
</code></pre></div></p> <p>Again, need to convert private.key into .pfx file.</p> <div class=highlight><pre><span></span><code><span class=n>openssl</span> <span class=n>pkcs12</span> <span class=n>-export</span> <span class=n>-out</span> <span class=n>private</span><span class=p>.</span><span class=n>pfx</span> <span class=n>-inkey</span> <span class=n>private</span><span class=p>.</span><span class=n>key</span> <span class=n>-in</span> <span class=n>cert</span><span class=p>.</span><span class=n>cer</span>
</code></pre></div> <p>We made all three certificates needed. (we could combine all into one, but that would be inflexible and less secure? maybe?)</p> <h2 id=setting-signing-policy-si-policy>Setting Signing Policy (Si Policy)<a class=headerlink href=#setting-signing-policy-si-policy title="Permanent link">&para;</a></h2> <p><del>We had to create xml file containing signing policy then convert into binary file, but this only works in Windows Enterprise/Education Edition. So <a href=https://www.geoffchappell.com/notes/windows/license/_download/sipolicy.zip>Download prebuild binary file.</a></del></p> <div class="admonition warning"> <p class=admonition-title>Maybe Harmful to Your Computer</p> <p><code>@ridingtheflow</code> told that this prebuilt SiPolicy states that it allows <em>any driver</em>. Also, downloading SiPolicy itself may be harmful.<br> Building SiPolicy with <code>New-CIPolicy</code> is also fishy, because it will by default create policy with <code>Enabled:Audit Mode</code>, which is meant for debugging.</p> </div> <p>Now sign <code>selfsign.bin</code> so that Windows recognizes it.</p> <div class=highlight><pre><span></span><code><span class=n>signtool</span> <span class=n>sign</span> <span class=p>/</span><span class=n>fd</span> <span class=n>sha256</span> <span class=p>/</span><span class=n>p7co</span> <span class=n>1</span><span class=p>.</span><span class=n>3</span><span class=p>.</span><span class=n>6</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>4</span><span class=p>.</span><span class=n>1</span><span class=p>.</span><span class=n>311</span><span class=p>.</span><span class=n>79</span><span class=p>.</span><span class=n>1</span> <span class=p>/</span><span class=n>p7</span> <span class=p>.</span> <span class=p>/</span><span class=n>f</span> <span class=n>platform-key</span><span class=p>/</span><span class=n>private</span><span class=p>.</span><span class=n>pfx</span> <span class=p>/</span><span class=n>p</span> <span class=cm>&lt;# password for platform-key #&gt;</span> <span class=n>sipolicy</span><span class=p>/</span><span class=n>selfsign</span><span class=p>.</span><span class=n>bin</span>
</code></pre></div> <ul> <li><code>sipolicy/selfsign.bin</code>: the file you downloaded right before</li> </ul> <p>Now you will see <code>selfsign.bin.p7</code> file. Rename it into <code>SiPolicy.p7b</code>. Open powershell with administrative privilege, (don't need to reopen if you are with) enter command:</p> <div class=highlight><pre><span></span><code><span class=c># Mount EFI system partition on X: drive (dangerous!)</span>
<span class=n>mountvol</span> <span class=n>x</span><span class=p>:</span> <span class=p>/</span><span class=n>s</span>

<span class=c># Copy SiPolicy</span>
<span class=nb>cp </span><span class=n>SiPolicy</span><span class=p>.</span><span class=n>p7b</span> <span class=n>X</span><span class=p>:\</span><span class=n>EFI</span><span class=p>\</span><span class=n>Microsoft</span><span class=p>\</span><span class=n>Boot</span><span class=p>\</span>

<span class=c># unmount EFI volume if you want</span>
<span class=n>mountvol</span> <span class=n>x</span><span class=p>:</span> <span class=p>/</span><span class=n>d</span>
</code></pre></div> <h2 id=turning-on-custom-kernel-signercks>Turning on Custom Kernel Signer(CKS)<a class=headerlink href=#turning-on-custom-kernel-signercks title="Permanent link">&para;</a></h2> <p>This value called 'CodeIntegrity-AllowConfigurablePolicy-CustomKernelSigners' is stored in <code>HKLM\SYSTEM\CurrentControlSet\Control\ProductOptions</code> in registry. This value can be set when kernel initialization is not finished. See <a href=https://github.com/HyperSine/Windows10-CustomKernelSigners>original documentation for more detail</a>.</p> <p><a href=https://github.com/valinet/ssde/releases>Download ssde.zip from here</a>. There is ssde.sys inside. We will sign this driver.</p> <div class=highlight><pre><span></span><code><span class=n>signtool</span> <span class=n>sign</span> <span class=p>/</span><span class=n>fd</span> <span class=n>sha256</span> <span class=p>/</span><span class=n>a</span> <span class=p>/</span><span class=nb>ac </span><span class=n>root-ca</span><span class=p>/</span><span class=n>cert</span><span class=p>.</span><span class=n>cer</span> <span class=p>/</span><span class=n>f</span> <span class=n>kernel-mode-driver</span><span class=p>/</span><span class=n>private</span><span class=p>.</span><span class=n>pfx</span> <span class=p>/</span><span class=n>p</span> <span class=cm>&lt;# password #&gt;</span> <span class=p>/</span><span class=n>td</span> <span class=n>sha256</span> <span class=p>/</span><span class=n>tr</span> <span class=n>http</span><span class=p>://</span><span class=n>sha256timestamp</span><span class=p>.</span><span class=n>ws</span><span class=p>.</span><span class=n>symantec</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>sha256</span><span class=p>/</span><span class=n>timestamp</span> <span class=n>ssde</span><span class=p>.</span><span class=n>sys</span>
</code></pre></div> <p>After running following commands, Windows recognizes some system driver is signed with unknown driver. (as we didn't configure some Code Integrity related values) So causing kernel fault. You will enter the recovery mode, known as WinRE, <strong>meaning you CANNOT BOOT until you change something there.</strong></p> <p>Those who fears a lot can configure WinPE(Windows Preinstalled Environment), but you may manually enter WinRE from UEFI, maybe? If you want check in advance. <del>but the author didn't EP2</del><br> To check if WinRE is available, run below. <div class=highlight><pre><span></span><code><span class=n>reagentc</span> <span class=p>/</span><span class=n>info</span>
</code></pre></div> If Windows RE status is <code>Enabled</code>, it will likely work. If not, you need to enable it by <code class=highlight><span class=n>reagentc</span> <span class=p>/</span><span class=n>enable</span></code>.</p> <p>Install the ssde.sys <strong>signed above</strong> by running command below in administrative privilege. (If you are in cmd, change <code class=highlight><span class=nv>$env:windir</span></code> to <code class=highlight><span class=nv>%windir%</span></code>.)</p> <div class=highlight><pre><span></span><code><span class=nb>cp </span><span class=n>ssde</span><span class=p>.</span><span class=n>sys</span> <span class=nv>$env:windir</span><span class=p>\</span><span class=n>system32</span><span class=p>\</span><span class=n>drivers</span><span class=p>\</span><span class=n>ssde</span><span class=p>.</span><span class=n>sys</span>
<span class=n>sc</span><span class=p>.</span><span class=n>exe</span> <span class=n>create</span> <span class=n>ssde</span> <span class=n>binpath</span><span class=p>=</span><span class=nv>$env:windir</span><span class=p>\</span><span class=n>system32</span><span class=p>\</span><span class=n>drivers</span><span class=p>\</span><span class=n>ssde</span><span class=p>.</span><span class=n>sys</span> <span class=n>type</span><span class=p>=</span><span class=n>kernel</span> <span class=n>start</span><span class=p>=</span><span class=n>boot</span> <span class=n>error</span><span class=p>=</span><span class=n>normal</span>
</code></pre></div> <p><strong>To revert this</strong>, you can just delete that driver in command prompt in recovery mode or somewhere, like <code class=highlight><span class=k>del</span> /F C:\Windows\System32\drivers\ssde.sys</code>. If you turn off Secure Boot even after you succeeded all steps, there will be no PK, so Windows won't recognize <code>ssde.sys</code> and you will be brought to recovery mode.</p> <p><strong>Watch following contents in your phone or write down in advance.</strong><br> Reboot your computer, and it will show different like 'Preparing Auto Repair'. This means booting failed and implies kernel panic.</p> <blockquote> <p>Your PC did not start correctly.</p> </blockquote> <p>Click <strong>Advanced options</strong>, then <strong>Troubleshoot &gt; Advanced options &gt; Command Prompt</strong>. Select your account and enter password. It will show a command prompt. Enter <code class=highlight>regedit</code> to enter Registry Editor. Select <code>HKEY_LOCAL_MACHINE</code>, go to <code>File(F)</code> &gt; <code>Load hive(L)...</code> then open <code>C:\Windows\System32\config\SYSTEM</code>, enter any name, (doesn't matter) then you will see '(any name)' under <code>HKEY_LOCAL_MACHINE</code>. select <code>ControlSet001\Control\CI\Protected</code> <strong>under (any name)</strong>, change the value <strong><code>Licensed</code> from <code>0</code> to <code>1</code></strong>.</p> <p><img alt=set-licensed src=../ssd/set-licensed.jpg></p> <p>Like this.</p> <p>We finished what we have to do. Close all windows and reboot, and it will start normally. Now start <code>ssde_info.exe</code> (from ssde.zip we've downloaded somewhere above) from shell. If it shows thingy like this:</p> <div class=highlight><pre><span></span><code>API version is 1.1
Arm count is 2
Arm watchdog status is 1
License tamper state is 0
</code></pre></div> <p>than you would likely have succeeded, as this driver was signed with our cert.</p> <p>Now restart your computer and check if it boots normally. If it does, we finished configuring self signing, Congratulations. If not, repeat going into recovery mode and setting registry a few times.</p> <p>If you want revert Secure Boot Mode from UEFI settings. (which was needed to set PK)</p> <p>Appendix: This didn't work well on my new laptop. However after I installed ssde service, I ran ssde_enable.exe then restarted -&gt; enter recovery mode -&gt; edited registry -&gt; restarted -&gt; (some cmd window automatically opened setting things up), which came up to be success.</p> <h2 id=reference>Reference<a class=headerlink href=#reference title="Permanent link">&para;</a></h2> <p>This document is based on ssde. Some references are:</p> <ul> <li><a href=https://github.com/valinet/ssde>Stable method: valinet/ssde</a></li> <li><a href=https://github.com/HyperSine/Windows10-CustomKernelSigners>First working PoC: HyperSine/Windows10-CustomKernelSigners</a></li> <li><a href=https://www.geoffchappell.com/notes/windows/license/customkernelsigners.htm>Original PoC: Licensed Driver Signing in Windows 10</a></li> </ul> <p>Some useful documents:</p> <ul> <li><a href=https://media.defense.gov/2020/Sep/15/2002497594/-1/-1/0/CTR-UEFI-Secure-Boot-Customization-UOO168873-20.PDF>Articles about UEFI Secure Boot from U.S. Defense</a></li> </ul> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; lhwdev 2021. See <a href=https://github.com/lhwdev/note/tree/master/LICENSE>License</a>. </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.dff1b7c8.min.js></script> </body> </html>