<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Where I write what I want to write"><meta name=author content=lhwdev><link href=http://lhwdev.github.io/note/compose/how-it-works/ rel=canonical><link href=../../kotlin-compiler-plugin/backend-ir/ rel=prev><link href=../../other/windows-self-driver-signing/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.5.2, mkdocs-material-9.3.1"><title>How Compose Works - Note</title><link rel=stylesheet href=../../assets/stylesheets/main.046329b4.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.85d0ee34.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script><meta property=og:type content=website><meta property=og:title content="Note - How Compose Works"><meta property=og:description content="Where I write what I want to write"></head> <body dir=ltr data-md-color-scheme=preference data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#how-compose-works class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class="md-header md-header--shadow" data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=../.. title=Note class="md-header__button md-logo" aria-label=Note data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Note </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> How Compose Works </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/lhwdev/note title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=Note class="md-nav__button md-logo" aria-label=Note data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Note </label> <div class=md-nav__source> <a href=https://github.com/lhwdev/note title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 6.4.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg> </div> <div class=md-source__repository> GitHub </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> <span class=md-ellipsis> Home </span> </a> </li> <li class=md-nav__item> <a href=../../making/ class=md-nav__link> <span class=md-ellipsis> Making this site </span> </a> </li> <li class=md-nav__item> <a href=../../debug-page/ class=md-nav__link> <span class=md-ellipsis> Debug page </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <label class=md-nav__link for=__nav_4 id=__nav_4_label tabindex=0> <span class=md-ellipsis> 고등학교 개발 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 고등학교 개발 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../high/covid-selftest-macro/ class=md-nav__link> <span class=md-ellipsis> 코로나19 자가진단 매크로를 만들며 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_5> <label class=md-nav__link for=__nav_5 id=__nav_5_label tabindex=0> <span class=md-ellipsis> Android </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_5_label aria-expanded=false> <label class=md-nav__title for=__nav_5> <span class="md-nav__icon md-icon"></span> Android </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../android/transparent-status-bar/ class=md-nav__link> <span class=md-ellipsis> Transparent status bar in Android </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_6> <label class=md-nav__link for=__nav_6 id=__nav_6_label tabindex=0> <span class=md-ellipsis> Kotlin Compiler Plugin </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_6_label aria-expanded=false> <label class=md-nav__title for=__nav_6> <span class="md-nav__icon md-icon"></span> Kotlin Compiler Plugin </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../kotlin-compiler-plugin/backend-ir/ class=md-nav__link> <span class=md-ellipsis> Writing a Kotlin Backend IR Compiler Plugin </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_7 checked> <label class=md-nav__link for=__nav_7 id=__nav_7_label tabindex=0> <span class=md-ellipsis> Jetpack compose </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_7_label aria-expanded=true> <label class=md-nav__title for=__nav_7> <span class="md-nav__icon md-icon"></span> Jetpack compose </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> How Compose Works </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> How Compose Works </span> </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#terms class=md-nav__link> Terms </a> </li> <li class=md-nav__item> <a href=#how-it-diffs-the-tree class=md-nav__link> How it diffs the tree </a> </li> <li class=md-nav__item> <a href=#how-it-detects-state-changes class=md-nav__link> How it detects state changes </a> </li> <li class=md-nav__item> <a href=#how-it-compiles class=md-nav__link> How it compiles </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_8> <label class=md-nav__link for=__nav_8 id=__nav_8_label tabindex=0> <span class=md-ellipsis> Other </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_8_label aria-expanded=false> <label class=md-nav__title for=__nav_8> <span class="md-nav__icon md-icon"></span> Other </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../other/windows-self-driver-signing/ class=md-nav__link> <span class=md-ellipsis> 윈도우에서 직접 드라이버 서명하기 </span> </a> </li> <li class=md-nav__item> <a href=../../other/windows-self-driver-signing-en/ class=md-nav__link> <span class=md-ellipsis> Self-signing on Windows </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#terms class=md-nav__link> Terms </a> </li> <li class=md-nav__item> <a href=#how-it-diffs-the-tree class=md-nav__link> How it diffs the tree </a> </li> <li class=md-nav__item> <a href=#how-it-detects-state-changes class=md-nav__link> How it detects state changes </a> </li> <li class=md-nav__item> <a href=#how-it-compiles class=md-nav__link> How it compiles </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=how-compose-works>How Compose works<a class=headerlink href=#how-compose-works title="Permanent link">&para;</a></h1> <div style="color: var(--md-default-fg-color--light); font-size: small; padding: -4px 0 12px 0;">2021-02-28</div> <div class="admonition warning"> <p class=admonition-title><strong>Under Construction</strong></p> <p>This document is not completed. (but still usable)</p> </div> <p>While I'm using compose(or Jetpack Compose), I was quite impressed how it was beautiful to write UI. (but note that Jetpack Compose itself has to do nothing with UI; it's a tool for building trees)</p> <p>I wondered how it works, I digged its runtime and compiler plugin. These are what I found.</p> <div class="admonition note"> <p class=admonition-title>Note</p> <p>You are expected to have a background about Compose model. This document only covers Compose itself, not Compose UI or related. Compose is in beta stage; these contents may be obsolete. Disclaimer: you may expect poor English &amp; explaination</p> </div> <h2 id=terms>Terms<a class=headerlink href=#terms title="Permanent link">&para;</a></h2> <ul> <li><strong>Composer</strong> is what manages the state of tree. Every Composable function receives this as a parameter.</li> <li><strong>Composition</strong> is an act building up a tree.</li> <li><strong>Recomposition</strong> is an act rebuilding a tree. You can access the corresponding part of the previous tree if exists.</li> </ul> <h2 id=how-it-diffs-the-tree>How it diffs the tree<a class=headerlink href=#how-it-diffs-the-tree title="Permanent link">&para;</a></h2> <p>Composable functions are what is called every time it recomposes. Calling another composable function marks that invocation into the Composer, which the function receives through its parameter. Of course you cannot see it in the code, but it does receive after transformed by compiler plugin. Then, Composer internally builds a <strong>slot table</strong> which is built on gap array.</p> <p>Slot table elements are called <code>slot</code>. The types of <code>slot</code> are: normal slot, <code>group</code>, <code>node</code>, <code>data</code>, etc. These are well explained in the <a href=https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-main/compose/runtime/runtime/src/commonMain/kotlin/androidx/compose/runtime/SlotTable.kt>source code of SlotTable</a>. One important thing is: <code>node</code>. Node is tracked by the Composer. When adapting Compose to your need(again, compose is a tree managing tool), you use <code>Applier</code>. When a node is inserted or removed, you get a callback from this.</p> <p>When first composing, Composer just writes down your composable into slot table. In the recomposition, if structure changes composer diffs your tree. But note that this diffing is not so same as something like React. Compiler plugin provides some diffing(it gives composer some hints about control flows and loops), so it has less overhead.</p> <p>There is <a href=https://youtu.be/Q9MtlmmN4Q0>a great video describing about this</a>.</p> <p>I'll explain more about other things.</p> <h2 id=how-it-detects-state-changes>How it detects state changes<a class=headerlink href=#how-it-detects-state-changes title="Permanent link">&para;</a></h2> <p>Consider the code below: <div class=highlight><pre><span></span><code><span class=kd>val</span><span class=w> </span><span class=nv>state</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>mutableStateOf</span><span class=p>(</span><span class=s>&quot;Apple&quot;</span><span class=p>)</span><span class=w> </span><span class=c1>// just for example</span>

<span class=nd>@Composable</span>
<span class=kd>fun</span><span class=w> </span><span class=nf>A</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>Text</span><span class=p>(</span><span class=s>&quot;wow, </span><span class=si>${</span><span class=n>state</span><span class=p>.</span><span class=na>value</span><span class=si>}</span><span class=s>!&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=n>Button</span><span class=p>(</span><span class=n>onClick</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>state</span><span class=p>.</span><span class=na>value</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;Banana&quot;</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=n>Text</span><span class=p>(</span><span class=s>&quot;hi&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>
</code></pre></div> Clicking the button changes the <code>state</code>, and <code>A</code> is recomposed automatically. But how?</p> <p><strong>Snapshot</strong> system handles this. While composing, your composer registers an observer to the current snapshot, and reading the state will fire the observer. It finally calls <code class=highlight><span class=n>composer</span><span class=p>.</span><span class=na>recordReadOf</span><span class=p>(</span><span class=n>state</span><span class=p>)</span></code> so your composable function automatically subscribes to that state. This is why you should not use normal mutable objects: they do not subscribe to the current snapshot by themselves.</p> <p>There are some predefined types to do this: <code>SnapshotStateList</code> and <code>SnapshotStateMap</code>, in addition to <code>SnapshotMutableState</code>.</p> <h2 id=how-it-compiles>How it compiles<a class=headerlink href=#how-it-compiles title="Permanent link">&para;</a></h2> <p><strong>Compose compiler plugin</strong> is built on the Backend IR, and transforms your Composable functions.</p> <p>Your code: <div class=highlight><pre><span></span><code><span class=nd>@Composable</span>
<span class=kd>fun</span><span class=w> </span><span class=nf>MyComposable</span><span class=p>(</span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=kt>String</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=nv>count</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=n>remember</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>mutableStateOf</span><span class=p>(</span><span class=m>1</span><span class=p>)</span><span class=w> </span><span class=p>}</span>

<span class=w>    </span><span class=n>Text</span><span class=p>(</span><span class=s>&quot;Clicked </span><span class=si>$</span><span class=n>count</span><span class=s> times&quot;</span><span class=p>,</span><span class=w> </span><span class=n>style</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MaterialTheme</span><span class=p>.</span><span class=na>typography</span><span class=p>.</span><span class=na>h2</span><span class=p>)</span>
<span class=w>    </span><span class=n>Button</span><span class=p>(</span><span class=n>onClick</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>count</span><span class=o>++</span><span class=w> </span><span class=p>})</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=n>Text</span><span class=p>(</span><span class=s>&quot;Click </span><span class=si>$</span><span class=n>name</span><span class=s>&quot;</span><span class=p>)</span>
<span class=w>    </span><span class=p>}</span>
<span class=p>}</span>


<span class=c1>// stubs for Compose UI</span>

<span class=nd>@Composable</span>
<span class=kd>fun</span><span class=w> </span><span class=nf>Text</span><span class=p>(</span><span class=n>text</span><span class=p>:</span><span class=w> </span><span class=kt>String</span><span class=p>,</span><span class=w> </span><span class=n>style</span><span class=p>:</span><span class=w> </span><span class=n>TextStyle</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TextStyle</span><span class=p>())</span>

<span class=nd>@Composable</span>
<span class=kd>fun</span><span class=w> </span><span class=nf>Button</span><span class=p>(</span><span class=n>onClick</span><span class=p>:</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kt>Unit</span><span class=p>,</span><span class=w> </span><span class=n>content</span><span class=p>:</span><span class=w> </span><span class=nd>@Composable</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kt>Unit</span><span class=p>)</span>

<span class=kd>object</span><span class=w> </span><span class=nc>MaterialTheme</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=nv>typography</span><span class=p>:</span><span class=w> </span><span class=n>Typography</span>
<span class=w>        </span><span class=nd>@Composable</span><span class=w> </span><span class=k>get</span><span class=p>()</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>TODO</span><span class=p>()</span>
<span class=p>}</span>

<span class=kd>data</span><span class=w> </span><span class=kd>class</span><span class=w> </span><span class=nc>Typography</span><span class=p>(</span><span class=kd>val</span><span class=w> </span><span class=nv>h2</span><span class=p>:</span><span class=w> </span><span class=n>TextStyle</span><span class=p>)</span>
</code></pre></div></p> <p>Compiled output(pseudo code): <div class=highlight><pre><span></span><code><span class=nd>@Composable</span>
<span class=kd>fun</span><span class=w> </span><span class=nf>MyComposable</span><span class=p>(</span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=kt>String</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>:</span><span class=w> </span><span class=n>Composer</span><span class=o>&lt;*&gt;</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>changed</span><span class=p>:</span><span class=w> </span><span class=kt>Int</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>startRestartGroup</span><span class=p>(</span><span class=m>193822</span><span class=p>)</span><span class=w> </span><span class=c1>// a hash of source location, eg) &quot;com.example/myFile.kt/MyComposable&quot;</span>
<span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=err>$</span><span class=nv>dirty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>$</span><span class=n>changed</span><span class=w> </span><span class=c1>// &#39;val&#39; is not a typo</span>

<span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=m>0</span><span class=n>b0110</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=m>0</span><span class=p>)</span>
<span class=w>        </span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>or</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>changed</span><span class=p>(</span><span class=n>name</span><span class=p>))</span><span class=w> </span><span class=m>0</span><span class=n>b0010</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=m>0</span><span class=n>b0100</span>

<span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=m>0</span><span class=n>b1011</span><span class=w> </span><span class=n>xor</span><span class=w> </span><span class=m>0</span><span class=n>b1010</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>skipping</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nv>count</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>cache</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>mutableStateOf</span><span class=p>(</span><span class=m>1</span><span class=p>)</span><span class=w> </span><span class=p>}</span>

<span class=w>        </span><span class=n>Text</span><span class=p>(</span>
<span class=w>            </span><span class=s>&quot;Clicked </span><span class=si>$</span><span class=n>count</span><span class=s> times&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=n>style</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MaterialTheme</span><span class=p>.</span><span class=o>&lt;</span><span class=k>get</span><span class=o>-</span><span class=n>typography</span><span class=o>&gt;</span><span class=p>(</span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=n>b0</span><span class=p>).</span><span class=na>h2</span><span class=p>,</span>
<span class=w>            </span><span class=err>$</span><span class=n>composer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>,</span>
<span class=w>            </span><span class=err>$</span><span class=n>changed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b0000000</span><span class=p>,</span>
<span class=w>            </span><span class=err>$</span><span class=n>default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b0</span>
<span class=w>        </span><span class=p>)</span>
<span class=w>        </span><span class=n>Button</span><span class=p>(</span><span class=n>onClick</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>count</span><span class=o>++</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=n>composableLambda</span><span class=p>(</span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>193702</span><span class=p>,</span><span class=w> </span><span class=n>tracked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>changed</span><span class=w> </span><span class=o>-&gt;</span>
<span class=w>            </span><span class=n>Text</span><span class=p>(</span>
<span class=w>                </span><span class=s>&quot;Click </span><span class=si>$</span><span class=n>name</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>style</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>                </span><span class=err>$</span><span class=n>composer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>,</span>
<span class=w>                </span><span class=err>$</span><span class=n>changed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b0000000</span><span class=w> </span><span class=n>or</span><span class=w> </span><span class=p>(</span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=m>0</span><span class=n>b1110</span><span class=p>),</span>
<span class=w>                </span><span class=err>$</span><span class=n>default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b1</span>
<span class=w>            </span><span class=p>)</span>
<span class=w>        </span><span class=p>},</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=n>b0000000</span><span class=p>)</span>
<span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>skipToGroupEnd</span><span class=p>()</span>
<span class=w>    </span><span class=p>}</span>
<span class=w>    </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>endRestartGroup</span><span class=p>()</span><span class=o>?.</span><span class=na>updateScope</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>composer</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>MyComposable</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>or</span><span class=w> </span><span class=m>0</span><span class=n>b1</span><span class=p>)</span><span class=w> </span><span class=p>}</span>
<span class=p>}</span>

<span class=c1>// ...</span>
</code></pre></div></p> <p>Wow, lots of things are done! Let's break up these things into pieces.</p> <p>The semantic of Composable function is similar to <code class=highlight><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span></code>.</p> <blockquote> <p><code class=highlight><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span></code> can call <code class=highlight><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span></code>; normal function cannot call <code class=highlight><span class=kd>suspend</span><span class=w> </span><span class=kd>fun</span></code>.</p> </blockquote> <p>Likewise, normal function cannot call <code class=highlight><span class=nd>@Composable</span><span class=w> </span><span class=kd>fun</span></code>. This is because, basically they are a different kind of function, and they receives an additional synthetic parameter: Composer.</p> <p><div class=highlight><pre><span></span><code><span class=nd>@Composable</span>
<span class=kd>fun</span><span class=w> </span><span class=nf>MyComposable</span><span class=p>(</span><span class=n>name</span><span class=p>:</span><span class=w> </span><span class=kt>String</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>:</span><span class=w> </span><span class=n>Composer</span><span class=o>&lt;*&gt;</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>changed</span><span class=p>:</span><span class=w> </span><span class=kt>Int</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=c1>// ...</span>
<span class=p>}</span>
</code></pre></div> You can see an synthetic paremeter <code class=highlight><span class=err>$</span><span class=n>composer</span><span class=p>:</span><span class=w> </span><span class=n>Composer</span><span class=o>&lt;*&gt;</span></code> is added.</p> <p>There's one more parameter: <code>$changed</code>.</p> <p>Composable function tries to skip execution when its parameters are unchanged. But comparing if parameters are changed is quite expensive in some cases. So Compose tries to avoid the comparison. When you just passes your argument to another Composable function as-is, Compose propagates the state, whether it is changed. The state is passed through <code>$changed</code>, which consists of 3-bit per parameter integer.</p> <p>The highest bit(0) indicates if it is <em>stable</em>. Stability is indicated via <code class=highlight><span class=nd>@Stable</span></code> etc, or inferred by the compiler plugin. 1 means unstable, and 0 means stable.</p> <p>Two lower bits(1, 2) indicates the status of the parameter like below.</p> <ul> <li> <p><strong>Uncertain</strong>(00) Indicates that nothing is certain about the current state of the parameter. It could be different than it was during the last execution, or it could be the same, but it is not known so the current function looking at it must call equals on it in order to find out. This is the only state that can cause the function to spend slot table space in order to look at it.</p> </li> <li> <p><strong>Same</strong>(01) This indicates that the value is known to be the same since the last time the function was executed. There is no need to store the value in the slot table in this case because the calling function will <em>always</em> know whether the value was the same or different as it was in the previous execution.</p> </li> <li> <p><strong>Different</strong>(10) This indicates that the value is known to be different since the last time the function was executed. There is no need to store the value in the slot table in this case because the calling function will <em>always</em> know whether the value was the same or different as it was in the previous execution.</p> </li> <li> <p><strong>Static</strong>(11) This indicates that the value is known to <em>never change</em> for the duration of the running program.</p> </li> </ul> <p>(documentation copied from Compose source)</p> <p>The lowest bit(2) indicates if it is changed, 1 for same and 0 for different. If the state is Uncertain(00), it will be replaced by the result of comparison.</p> <p>The lowest bit of <code>$changed</code> itself is a special bit indicating a force recomposition, set to 1 when it recomposes.</p> <p><div class=highlight><pre><span></span><code><span class=w>    </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>startRestartGroup</span><span class=p>(</span><span class=m>193822</span><span class=p>)</span>
</code></pre></div> Every Composable function produces a group.</p> <p><div class=highlight><pre><span></span><code><span class=w>    </span><span class=kd>val</span><span class=w> </span><span class=err>$</span><span class=nv>dirty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>$</span><span class=n>changed</span><span class=w> </span><span class=c1>// &#39;val&#39; is not a typo</span>

<span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=m>0</span><span class=n>b0110</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=m>0</span><span class=n>b0000</span><span class=p>)</span>
<span class=w>        </span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>or</span><span class=w> </span><span class=k>if</span><span class=p>(</span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>changed</span><span class=p>(</span><span class=n>name</span><span class=p>))</span><span class=w> </span><span class=m>0</span><span class=n>b0010</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=m>0</span><span class=n>b0100</span>
</code></pre></div> As described above, it checks the <code>$changed</code> parameter(in turn <code>$dirty</code>). If the state is Uncertain(00), it compares the parameter via <code class=highlight><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>changed</span><span class=p>(</span><span class=n>argument</span><span class=p>)</span></code>.</p> <p>What it internally does:</p> <ol> <li>Retrives the previous slot if exist(let be <code>previous</code>; if not exist then becomes a special singleton value <code>EMPTY</code>)</li> <li>Saves the <code>argument</code> into the slot table</li> <li>Returns <code class=highlight><span class=n>previous</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=n>argument</span></code>.</li> </ol> <p>So if <code>argument</code> is changed, the state becomes Different(10). If not, becomes Same(01).</p> <p><div class=highlight><pre><span></span><code><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=m>0</span><span class=n>b1011</span><span class=w> </span><span class=n>xor</span><span class=w> </span><span class=m>0</span><span class=n>b1010</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=m>0</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=o>!</span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>skipping</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=c1>// ...</span>
<span class=w>    </span><span class=p>}</span>
</code></pre></div> If all parameters are Same(001) and Stable(100), and the composer allows skipping, the execution is skipped. If not, it will execute.</p> <p><div class=highlight><pre><span></span><code><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=nv>count</span><span class=w> </span><span class=k>by</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>cache</span><span class=p>(</span><span class=kc>true</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>mutableStateOf</span><span class=p>(</span><span class=m>1</span><span class=p>)</span><span class=w> </span><span class=p>}</span>
</code></pre></div> This is special kind of transformation. <code class=highlight><span class=n>remember</span><span class=p>(..)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>expr</span><span class=w> </span><span class=p>}</span></code> becomes <code class=highlight><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>cache</span><span class=p>(..)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>expr</span><span class=w> </span><span class=p>}</span></code>. <code>true</code> means it does not always have to update.</p> <p><div class=highlight><pre><span></span><code><span class=w>        </span><span class=n>Text</span><span class=p>(</span>
<span class=w>            </span><span class=s>&quot;Clicked </span><span class=si>$</span><span class=n>count</span><span class=s> times&quot;</span><span class=p>,</span>
<span class=w>            </span><span class=n>style</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MaterialTheme</span><span class=p>.</span><span class=o>&lt;</span><span class=k>get</span><span class=o>-</span><span class=n>typography</span><span class=o>&gt;</span><span class=p>(</span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=n>b0</span><span class=p>).</span><span class=na>h2</span><span class=p>,</span>
<span class=w>            </span><span class=err>$</span><span class=n>composer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>,</span>
<span class=w>            </span><span class=err>$</span><span class=n>changed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b0000000</span><span class=p>,</span>
<span class=w>            </span><span class=err>$</span><span class=n>default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b0</span>
<span class=w>        </span><span class=p>)</span>
</code></pre></div> This is a normal Composable function call.</p> <p>You can see something strange: <code class=highlight><span class=n>MaterialTheme</span><span class=p>.</span><span class=o>&lt;</span><span class=k>get</span><span class=o>-</span><span class=n>typography</span><span class=o>&gt;</span><span class=p>(</span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=n>b0</span><span class=p>)</span></code>. As you might know, every property consists of getter, optional setter, and optional backing field. Getting property basically corresponds to calling getter internally. Its name is called <code>&lt;get-propertyName&gt;</code> in IR. As it is a normal function, compiler plugin can add a value parameter to getter. (yet impossible in plain Kotlin code)</p> <p>So, Composable function passes its <code>$composer</code> to Composable function, and <code>$changed</code> argument. It checks for all dependencies associated with that argument. For example, if the argument is <code class=highlight><span class=s>&quot;Hello, </span><span class=si>$</span><span class=n>name</span><span class=s>(</span><span class=si>$</span><span class=n>age</span><span class=s>)!&quot;</span></code>, it depends on <code>name</code> and <code>age</code>.</p> <p>If a variable is</p> <ul> <li><code class=highlight><span class=kd>const</span><span class=w> </span><span class=kd>val</span></code>, global <code>val</code>, object etc: Static</li> <li>remember without keys(<code class=highlight><span class=n>remember</span><span class=p>(</span><span class=cm>/* nothing here */</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=p>..</span><span class=w> </span><span class=p>}</span></code>): Static</li> <li>parameter: delegated (like <code class=highlight><span class=err>$</span><span class=n>changedN</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=m>0</span><span class=n>b1110</span><span class=w> </span><span class=n>shl</span><span class=w> </span><span class=m>3</span></code>)</li> </ul> <p>If an expression is</p> <ul> <li>builtin expressions(Int.plus, "$variable, string, ${someExpr()}" etc): combine all of its value parameters/receivers</li> <li>calling <code class=highlight><span class=nd>@Stable</span><span class=w> </span><span class=kd>fun</span></code>: combine all of</li> <li>unknown arbitrary function call: Unknown</li> </ul> <p>Also, whether all dependencies are <em>Stable</em> is marked. For more information, you can check <a href=https://android.googlesource.com/platform/frameworks/support/+/refs/heads/androidx-main/compose/compiler/compiler-hosted/src/main/java/androidx/compose/compiler/plugins/kotlin/analysis/Stability.kt>the source code of StabilityInferencer</a>.</p> <p>You can also see <code>$default</code>. Compose compiler plugin handles the default parameter by itself. It is almost identical to that of Kotlin, but Compose do not generate another function.</p> <p>Bit <code>1</code> means caller did <strong>not</strong> provide that parameter so requires special handling.</p> <p><div class=highlight><pre><span></span><code><span class=w>        </span><span class=n>Button</span><span class=p>(</span><span class=n>onClick</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>count</span><span class=o>++</span><span class=w> </span><span class=p>},</span><span class=w> </span><span class=n>composableLambda</span><span class=p>(</span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>193702</span><span class=p>,</span><span class=w> </span><span class=n>tracked</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>,</span><span class=w> </span><span class=kc>null</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>changed</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=cm>/* ... */</span><span class=w> </span><span class=p>})</span>
</code></pre></div> Composable lambda is handled specially. Group is inserted surrounding most Composable functions, but it is inserted by <code>composableLambda</code>.</p> <p>Compose compiler plugin remembers the resulting lambda instance, and even the original lambda itself if it does not have captures. So the result of <code class=highlight><span class=n>composableLambda</span><span class=p>(..)</span></code>, hence seemingly all the Composable lambda is ensured to be identical(<code>a === b</code>).</p> <p><div class=highlight><pre><span></span><code><span class=w>            </span><span class=n>Text</span><span class=p>(</span>
<span class=w>                </span><span class=s>&quot;Click </span><span class=si>$</span><span class=n>name</span><span class=s>&quot;</span><span class=p>,</span><span class=w> </span><span class=n>style</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>,</span>
<span class=w>                </span><span class=err>$</span><span class=n>composer</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>,</span>
<span class=w>                </span><span class=err>$</span><span class=n>changed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b0000000</span><span class=w> </span><span class=n>or</span><span class=w> </span><span class=p>(</span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>and</span><span class=w> </span><span class=m>0</span><span class=n>b1110</span><span class=p>),</span>
<span class=w>                </span><span class=err>$</span><span class=n>default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b1</span>
<span class=w>            </span><span class=p>)</span>
<span class=w>        </span><span class=p>},</span><span class=w> </span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=n>b0000000</span><span class=p>)</span>
</code></pre></div> Here we propagate the state of parameter <code>name</code> to the first argument <code>text</code>. We also use the default value of <code>style</code>, so we pass <code class=highlight><span class=err>$</span><span class=n>default</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=m>0</span><span class=n>b1</span></code>.</p> <p><div class=highlight><pre><span></span><code><span class=w>    </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<span class=w>        </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>skipToGroupEnd</span><span class=p>()</span>
<span class=w>    </span><span class=p>}</span>
</code></pre></div> If we can skip this function, skip it.</p> <p><div class=highlight><pre><span></span><code><span class=w>    </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>endRestartGroup</span><span class=p>()</span><span class=o>?.</span><span class=na>updateScope</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>composer</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>MyComposable</span><span class=p>(</span><span class=n>name</span><span class=p>,</span><span class=w> </span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=err>$</span><span class=n>dirty</span><span class=w> </span><span class=n>or</span><span class=w> </span><span class=m>0</span><span class=n>b1</span><span class=p>)</span><span class=w> </span><span class=p>}</span>
</code></pre></div> Finally, ends the group. <code>updateScope() { ... }</code> is related to Composable function Restart. If it can, it updates the restartable scope. The lambda provided to <code>updateScope</code> is used to restart the Composable function. If something changes, like updating state happen, Compose finds the subscribers (where the state is used) and retrieves the nearest restartable scope, and invokes it.</p> <p>You can see Compose compiler plugin is quite complex.</p> <p>Composer does more: it transforms <strong>control flows</strong> and <strong>loops</strong>.</p> <p><div class=highlight><pre><span></span><code><span class=k>if</span><span class=p>(</span><span class=n>condition</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>simpleFunction</span><span class=p>()</span>
<span class=w>    </span><span class=n>a</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=m>1</span>
<span class=p>}</span>
</code></pre></div> Codes like this are not transformed, but</p> <p><div class=highlight><pre><span></span><code><span class=k>if</span><span class=p>(</span><span class=n>condition</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=n>ComposableFunction</span><span class=p>()</span>
<span class=p>}</span>
</code></pre></div> Codes that calls Composable fun in the condition or its result gets transformed.</p> <p>Result: <div class=highlight><pre><span></span><code><span class=k>if</span><span class=p>(</span><span class=n>condition</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>startReplaceableGroup</span><span class=p>(</span><span class=m>29381</span><span class=p>)</span>
<span class=w>    </span><span class=n>ComposableFunction</span><span class=p>(</span><span class=err>$</span><span class=n>composer</span><span class=p>,</span><span class=w> </span><span class=m>0</span><span class=p>)</span>
<span class=p>}</span><span class=w> </span><span class=k>else</span><span class=w> </span><span class=p>{</span>
<span class=w>    </span><span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>startReplaceableGroup</span><span class=p>(</span><span class=m>193052</span><span class=p>)</span>
<span class=p>}</span>
<span class=err>$</span><span class=n>composer</span><span class=p>.</span><span class=na>endReplaceableGroup</span><span class=p>()</span>
</code></pre></div></p> <p>That is, Compose compiler handles code that <strong>may not run only once</strong>. In the previous example, <code>ComposableFunction</code> may not run or may run once.</p> <p>The reason composer handles this is: Composer call is sequential. Without this transformation, the tree may go wrong.</p> </article> </div> </div> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; lhwdev 2021. See <a href=https://github.com/lhwdev/note/tree/master/LICENSE>License</a>. </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["navigation.instant"], "search": "../../assets/javascripts/workers/search.dfff1995.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script> <script src=../../assets/javascripts/bundle.dff1b7c8.min.js></script> </body> </html>